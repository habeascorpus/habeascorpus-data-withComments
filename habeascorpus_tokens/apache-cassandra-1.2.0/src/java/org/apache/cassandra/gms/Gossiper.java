/* * Licensed to the Apache Software Foundation (ASF) under one * or more contributor license agreements. See the NOTICE file * distributed with this work for additional information * regarding copyright ownership. The ASF licenses this file * to you under the Apache License, Version 2.0 (the * "License"); you may not use this file except in compliance * with the License. You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */	TokenNameCOMMENT_BLOCK	 Licensed to the Apache Software Foundation (ASF) under one or more contributor license agreements. See the NOTICE file distributed with this work for additional information regarding copyright ownership. The ASF licenses this file to you under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at * http://www.apache.org/licenses/LICENSE-2.0 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License. 
package	TokenNamepackage	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
apache	TokenNameIdentifier	 apache
.	TokenNameDOT	
cassandra	TokenNameIdentifier	 cassandra
.	TokenNameDOT	
gms	TokenNameIdentifier	 gms
;	TokenNameSEMICOLON	
import	TokenNameimport	
java	TokenNameIdentifier	 java
.	TokenNameDOT	
lang	TokenNameIdentifier	 lang
.	TokenNameDOT	
management	TokenNameIdentifier	 management
.	TokenNameDOT	
ManagementFactory	TokenNameIdentifier	 Management Factory
;	TokenNameSEMICOLON	
import	TokenNameimport	
java	TokenNameIdentifier	 java
.	TokenNameDOT	
net	TokenNameIdentifier	 net
.	TokenNameDOT	
InetAddress	TokenNameIdentifier	 Inet Address
;	TokenNameSEMICOLON	
import	TokenNameimport	
java	TokenNameIdentifier	 java
.	TokenNameDOT	
net	TokenNameIdentifier	 net
.	TokenNameDOT	
UnknownHostException	TokenNameIdentifier	 Unknown Host Exception
;	TokenNameSEMICOLON	
import	TokenNameimport	
java	TokenNameIdentifier	 java
.	TokenNameDOT	
util	TokenNameIdentifier	 util
.	TokenNameDOT	
*	TokenNameMULTIPLY	
;	TokenNameSEMICOLON	
import	TokenNameimport	
java	TokenNameIdentifier	 java
.	TokenNameDOT	
util	TokenNameIdentifier	 util
.	TokenNameDOT	
Map	TokenNameIdentifier	 Map
.	TokenNameDOT	
Entry	TokenNameIdentifier	 Entry
;	TokenNameSEMICOLON	
import	TokenNameimport	
java	TokenNameIdentifier	 java
.	TokenNameDOT	
util	TokenNameIdentifier	 util
.	TokenNameDOT	
concurrent	TokenNameIdentifier	 concurrent
.	TokenNameDOT	
*	TokenNameMULTIPLY	
;	TokenNameSEMICOLON	
import	TokenNameimport	
javax	TokenNameIdentifier	 javax
.	TokenNameDOT	
management	TokenNameIdentifier	 management
.	TokenNameDOT	
MBeanServer	TokenNameIdentifier	 M Bean Server
;	TokenNameSEMICOLON	
import	TokenNameimport	
javax	TokenNameIdentifier	 javax
.	TokenNameDOT	
management	TokenNameIdentifier	 management
.	TokenNameDOT	
ObjectName	TokenNameIdentifier	 Object Name
;	TokenNameSEMICOLON	
import	TokenNameimport	
com	TokenNameIdentifier	 com
.	TokenNameDOT	
google	TokenNameIdentifier	 google
.	TokenNameDOT	
common	TokenNameIdentifier	 common
.	TokenNameDOT	
annotations	TokenNameIdentifier	 annotations
.	TokenNameDOT	
VisibleForTesting	TokenNameIdentifier	 Visible For Testing
;	TokenNameSEMICOLON	
import	TokenNameimport	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
slf4j	TokenNameIdentifier	 slf4j
.	TokenNameDOT	
Logger	TokenNameIdentifier	 Logger
;	TokenNameSEMICOLON	
import	TokenNameimport	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
slf4j	TokenNameIdentifier	 slf4j
.	TokenNameDOT	
LoggerFactory	TokenNameIdentifier	 Logger Factory
;	TokenNameSEMICOLON	
import	TokenNameimport	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
apache	TokenNameIdentifier	 apache
.	TokenNameDOT	
cassandra	TokenNameIdentifier	 cassandra
.	TokenNameDOT	
concurrent	TokenNameIdentifier	 concurrent
.	TokenNameDOT	
DebuggableScheduledThreadPoolExecutor	TokenNameIdentifier	 Debuggable Scheduled Thread Pool Executor
;	TokenNameSEMICOLON	
import	TokenNameimport	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
apache	TokenNameIdentifier	 apache
.	TokenNameDOT	
cassandra	TokenNameIdentifier	 cassandra
.	TokenNameDOT	
config	TokenNameIdentifier	 config
.	TokenNameDOT	
DatabaseDescriptor	TokenNameIdentifier	 Database Descriptor
;	TokenNameSEMICOLON	
import	TokenNameimport	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
apache	TokenNameIdentifier	 apache
.	TokenNameDOT	
cassandra	TokenNameIdentifier	 cassandra
.	TokenNameDOT	
dht	TokenNameIdentifier	 dht
.	TokenNameDOT	
Token	TokenNameIdentifier	 Token
;	TokenNameSEMICOLON	
import	TokenNameimport	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
apache	TokenNameIdentifier	 apache
.	TokenNameDOT	
cassandra	TokenNameIdentifier	 cassandra
.	TokenNameDOT	
net	TokenNameIdentifier	 net
.	TokenNameDOT	
MessageOut	TokenNameIdentifier	 Message Out
;	TokenNameSEMICOLON	
import	TokenNameimport	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
apache	TokenNameIdentifier	 apache
.	TokenNameDOT	
cassandra	TokenNameIdentifier	 cassandra
.	TokenNameDOT	
net	TokenNameIdentifier	 net
.	TokenNameDOT	
MessagingService	TokenNameIdentifier	 Messaging Service
;	TokenNameSEMICOLON	
import	TokenNameimport	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
apache	TokenNameIdentifier	 apache
.	TokenNameDOT	
cassandra	TokenNameIdentifier	 cassandra
.	TokenNameDOT	
service	TokenNameIdentifier	 service
.	TokenNameDOT	
StorageService	TokenNameIdentifier	 Storage Service
;	TokenNameSEMICOLON	
import	TokenNameimport	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
apache	TokenNameIdentifier	 apache
.	TokenNameDOT	
cassandra	TokenNameIdentifier	 cassandra
.	TokenNameDOT	
utils	TokenNameIdentifier	 utils
.	TokenNameDOT	
FBUtilities	TokenNameIdentifier	 FB Utilities
;	TokenNameSEMICOLON	
/** * This module is responsible for Gossiping information for the local endpoint. This abstraction * maintains the list of live and dead endpoints. Periodically i.e. every 1 second this module * chooses a random node and initiates a round of Gossip with it. A round of Gossip involves 3 * rounds of messaging. For instance if node A wants to initiate a round of Gossip with node B * it starts off by sending node B a GossipDigestSynMessage. Node B on receipt of this message * sends node A a GossipDigestAckMessage. On receipt of this message node A sends node B a * GossipDigestAck2Message which completes a round of Gossip. This module as and when it hears one * of the three above mentioned messages updates the Failure Detector with the liveness information. * Upon hearing a GossipShutdownMessage, this module will instantly mark the remote node as down in * the Failure Detector. */	TokenNameCOMMENT_JAVADOC	 This module is responsible for Gossiping information for the local endpoint. This abstraction maintains the list of live and dead endpoints. Periodically i.e. every 1 second this module chooses a random node and initiates a round of Gossip with it. A round of Gossip involves 3 rounds of messaging. For instance if node A wants to initiate a round of Gossip with node B it starts off by sending node B a GossipDigestSynMessage. Node B on receipt of this message sends node A a GossipDigestAckMessage. On receipt of this message node A sends node B a GossipDigestAck2Message which completes a round of Gossip. This module as and when it hears one of the three above mentioned messages updates the Failure Detector with the liveness information. Upon hearing a GossipShutdownMessage, this module will instantly mark the remote node as down in the Failure Detector. 
public	TokenNamepublic	
class	TokenNameclass	
Gossiper	TokenNameIdentifier	 Gossiper
implements	TokenNameimplements	
IFailureDetectionEventListener	TokenNameIdentifier	 I Failure Detection Event Listener
,	TokenNameCOMMA	
GossiperMBean	TokenNameIdentifier	 Gossiper M Bean
{	TokenNameLBRACE	
private	TokenNameprivate	
static	TokenNamestatic	
final	TokenNamefinal	
String	TokenNameIdentifier	 String
MBEAN_NAME	TokenNameIdentifier	 MBEAN  NAME
=	TokenNameEQUAL	
"org.apache.cassandra.net:type=Gossiper"	TokenNameStringLiteral	org.apache.cassandra.net:type=Gossiper
;	TokenNameSEMICOLON	
private	TokenNameprivate	
static	TokenNamestatic	
final	TokenNamefinal	
DebuggableScheduledThreadPoolExecutor	TokenNameIdentifier	 Debuggable Scheduled Thread Pool Executor
executor	TokenNameIdentifier	 executor
=	TokenNameEQUAL	
new	TokenNamenew	
DebuggableScheduledThreadPoolExecutor	TokenNameIdentifier	 Debuggable Scheduled Thread Pool Executor
(	TokenNameLPAREN	
"GossipTasks"	TokenNameStringLiteral	GossipTasks
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
static	TokenNamestatic	
final	TokenNamefinal	
ApplicationState	TokenNameIdentifier	 Application State
[	TokenNameLBRACKET	
]	TokenNameRBRACKET	
STATES	TokenNameIdentifier	 STATES
=	TokenNameEQUAL	
ApplicationState	TokenNameIdentifier	 Application State
.	TokenNameDOT	
values	TokenNameIdentifier	 values
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
static	TokenNamestatic	
final	TokenNamefinal	
List	TokenNameIdentifier	 List
<	TokenNameLESS	
String	TokenNameIdentifier	 String
>	TokenNameGREATER	
DEAD_STATES	TokenNameIdentifier	 DEAD  STATES
=	TokenNameEQUAL	
Arrays	TokenNameIdentifier	 Arrays
.	TokenNameDOT	
asList	TokenNameIdentifier	 as List
(	TokenNameLPAREN	
VersionedValue	TokenNameIdentifier	 Versioned Value
.	TokenNameDOT	
REMOVING_TOKEN	TokenNameIdentifier	 REMOVING  TOKEN
,	TokenNameCOMMA	
VersionedValue	TokenNameIdentifier	 Versioned Value
.	TokenNameDOT	
REMOVED_TOKEN	TokenNameIdentifier	 REMOVED  TOKEN
,	TokenNameCOMMA	
VersionedValue	TokenNameIdentifier	 Versioned Value
.	TokenNameDOT	
STATUS_LEFT	TokenNameIdentifier	 STATUS  LEFT
,	TokenNameCOMMA	
VersionedValue	TokenNameIdentifier	 Versioned Value
.	TokenNameDOT	
HIBERNATE	TokenNameIdentifier	 HIBERNATE
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
private	TokenNameprivate	
ScheduledFuture	TokenNameIdentifier	 Scheduled Future
<	TokenNameLESS	
?	TokenNameQUESTION	
>	TokenNameGREATER	
scheduledGossipTask	TokenNameIdentifier	 scheduled Gossip Task
;	TokenNameSEMICOLON	
public	TokenNamepublic	
final	TokenNamefinal	
static	TokenNamestatic	
int	TokenNameint	
intervalInMillis	TokenNameIdentifier	 interval In Millis
=	TokenNameEQUAL	
1000	TokenNameIntegerLiteral	
;	TokenNameSEMICOLON	
public	TokenNamepublic	
final	TokenNamefinal	
static	TokenNamestatic	
int	TokenNameint	
QUARANTINE_DELAY	TokenNameIdentifier	 QUARANTINE  DELAY
=	TokenNameEQUAL	
StorageService	TokenNameIdentifier	 Storage Service
.	TokenNameDOT	
RING_DELAY	TokenNameIdentifier	 RING  DELAY
*	TokenNameMULTIPLY	
2	TokenNameIntegerLiteral	
;	TokenNameSEMICOLON	
private	TokenNameprivate	
static	TokenNamestatic	
final	TokenNamefinal	
Logger	TokenNameIdentifier	 Logger
logger	TokenNameIdentifier	 logger
=	TokenNameEQUAL	
LoggerFactory	TokenNameIdentifier	 Logger Factory
.	TokenNameDOT	
getLogger	TokenNameIdentifier	 get Logger
(	TokenNameLPAREN	
Gossiper	TokenNameIdentifier	 Gossiper
.	TokenNameDOT	
class	TokenNameclass	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
public	TokenNamepublic	
static	TokenNamestatic	
final	TokenNamefinal	
Gossiper	TokenNameIdentifier	 Gossiper
instance	TokenNameIdentifier	 instance
=	TokenNameEQUAL	
new	TokenNamenew	
Gossiper	TokenNameIdentifier	 Gossiper
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
public	TokenNamepublic	
static	TokenNamestatic	
final	TokenNamefinal	
long	TokenNamelong	
aVeryLongTime	TokenNameIdentifier	 a Very Long Time
=	TokenNameEQUAL	
259200	TokenNameIntegerLiteral	
*	TokenNameMULTIPLY	
1000	TokenNameIntegerLiteral	
;	TokenNameSEMICOLON	
// 3 days 	TokenNameCOMMENT_LINE	3 days 
private	TokenNameprivate	
long	TokenNamelong	
FatClientTimeout	TokenNameIdentifier	 Fat Client Timeout
;	TokenNameSEMICOLON	
private	TokenNameprivate	
final	TokenNamefinal	
Random	TokenNameIdentifier	 Random
random	TokenNameIdentifier	 random
=	TokenNameEQUAL	
new	TokenNamenew	
Random	TokenNameIdentifier	 Random
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
private	TokenNameprivate	
final	TokenNamefinal	
Comparator	TokenNameIdentifier	 Comparator
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
>	TokenNameGREATER	
inetcomparator	TokenNameIdentifier	 inetcomparator
=	TokenNameEQUAL	
new	TokenNamenew	
Comparator	TokenNameIdentifier	 Comparator
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
>	TokenNameGREATER	
(	TokenNameLPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
public	TokenNamepublic	
int	TokenNameint	
compare	TokenNameIdentifier	 compare
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
addr1	TokenNameIdentifier	 addr1
,	TokenNameCOMMA	
InetAddress	TokenNameIdentifier	 Inet Address
addr2	TokenNameIdentifier	 addr2
)	TokenNameRPAREN	
{	TokenNameLBRACE	
return	TokenNamereturn	
addr1	TokenNameIdentifier	 addr1
.	TokenNameDOT	
getHostAddress	TokenNameIdentifier	 get Host Address
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
compareTo	TokenNameIdentifier	 compare To
(	TokenNameLPAREN	
addr2	TokenNameIdentifier	 addr2
.	TokenNameDOT	
getHostAddress	TokenNameIdentifier	 get Host Address
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
;	TokenNameSEMICOLON	
/* subscribers for interest in EndpointState change */	TokenNameCOMMENT_BLOCK	 subscribers for interest in EndpointState change 
private	TokenNameprivate	
final	TokenNamefinal	
List	TokenNameIdentifier	 List
<	TokenNameLESS	
IEndpointStateChangeSubscriber	TokenNameIdentifier	 I Endpoint State Change Subscriber
>	TokenNameGREATER	
subscribers	TokenNameIdentifier	 subscribers
=	TokenNameEQUAL	
new	TokenNamenew	
CopyOnWriteArrayList	TokenNameIdentifier	 Copy On Write Array List
<	TokenNameLESS	
IEndpointStateChangeSubscriber	TokenNameIdentifier	 I Endpoint State Change Subscriber
>	TokenNameGREATER	
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
/* live member set */	TokenNameCOMMENT_BLOCK	 live member set 
private	TokenNameprivate	
final	TokenNamefinal	
Set	TokenNameIdentifier	 Set
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
>	TokenNameGREATER	
liveEndpoints	TokenNameIdentifier	 live Endpoints
=	TokenNameEQUAL	
new	TokenNamenew	
ConcurrentSkipListSet	TokenNameIdentifier	 Concurrent Skip List Set
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
>	TokenNameGREATER	
(	TokenNameLPAREN	
inetcomparator	TokenNameIdentifier	 inetcomparator
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
/* unreachable member set */	TokenNameCOMMENT_BLOCK	 unreachable member set 
private	TokenNameprivate	
final	TokenNamefinal	
Map	TokenNameIdentifier	 Map
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
,	TokenNameCOMMA	
Long	TokenNameIdentifier	 Long
>	TokenNameGREATER	
unreachableEndpoints	TokenNameIdentifier	 unreachable Endpoints
=	TokenNameEQUAL	
new	TokenNamenew	
ConcurrentHashMap	TokenNameIdentifier	 Concurrent Hash Map
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
,	TokenNameCOMMA	
Long	TokenNameIdentifier	 Long
>	TokenNameGREATER	
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
/* initial seeds for joining the cluster */	TokenNameCOMMENT_BLOCK	 initial seeds for joining the cluster 
private	TokenNameprivate	
final	TokenNamefinal	
Set	TokenNameIdentifier	 Set
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
>	TokenNameGREATER	
seeds	TokenNameIdentifier	 seeds
=	TokenNameEQUAL	
new	TokenNamenew	
ConcurrentSkipListSet	TokenNameIdentifier	 Concurrent Skip List Set
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
>	TokenNameGREATER	
(	TokenNameLPAREN	
inetcomparator	TokenNameIdentifier	 inetcomparator
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
/* map where key is the endpoint and value is the state associated with the endpoint */	TokenNameCOMMENT_BLOCK	 map where key is the endpoint and value is the state associated with the endpoint 
final	TokenNamefinal	
ConcurrentMap	TokenNameIdentifier	 Concurrent Map
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
,	TokenNameCOMMA	
EndpointState	TokenNameIdentifier	 Endpoint State
>	TokenNameGREATER	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
=	TokenNameEQUAL	
new	TokenNamenew	
ConcurrentHashMap	TokenNameIdentifier	 Concurrent Hash Map
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
,	TokenNameCOMMA	
EndpointState	TokenNameIdentifier	 Endpoint State
>	TokenNameGREATER	
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
/* map where key is endpoint and value is timestamp when this endpoint was removed from * gossip. We will ignore any gossip regarding these endpoints for QUARANTINE_DELAY time * after removal to prevent nodes from falsely reincarnating during the time when removal * gossip gets propagated to all nodes */	TokenNameCOMMENT_BLOCK	 map where key is endpoint and value is timestamp when this endpoint was removed from gossip. We will ignore any gossip regarding these endpoints for QUARANTINE_DELAY time after removal to prevent nodes from falsely reincarnating during the time when removal gossip gets propagated to all nodes 
private	TokenNameprivate	
final	TokenNamefinal	
Map	TokenNameIdentifier	 Map
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
,	TokenNameCOMMA	
Long	TokenNameIdentifier	 Long
>	TokenNameGREATER	
justRemovedEndpoints	TokenNameIdentifier	 just Removed Endpoints
=	TokenNameEQUAL	
new	TokenNamenew	
ConcurrentHashMap	TokenNameIdentifier	 Concurrent Hash Map
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
,	TokenNameCOMMA	
Long	TokenNameIdentifier	 Long
>	TokenNameGREATER	
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
private	TokenNameprivate	
final	TokenNamefinal	
Map	TokenNameIdentifier	 Map
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
,	TokenNameCOMMA	
Long	TokenNameIdentifier	 Long
>	TokenNameGREATER	
expireTimeEndpointMap	TokenNameIdentifier	 expire Time Endpoint Map
=	TokenNameEQUAL	
new	TokenNamenew	
ConcurrentHashMap	TokenNameIdentifier	 Concurrent Hash Map
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
,	TokenNameCOMMA	
Long	TokenNameIdentifier	 Long
>	TokenNameGREATER	
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
private	TokenNameprivate	
class	TokenNameclass	
GossipTask	TokenNameIdentifier	 Gossip Task
implements	TokenNameimplements	
Runnable	TokenNameIdentifier	 Runnable
{	TokenNameLBRACE	
public	TokenNamepublic	
void	TokenNamevoid	
run	TokenNameIdentifier	 run
(	TokenNameLPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
try	TokenNametry	
{	TokenNameLBRACE	
//wait on messaging service to start listening 	TokenNameCOMMENT_LINE	wait on messaging service to start listening 
MessagingService	TokenNameIdentifier	 Messaging Service
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
waitUntilListening	TokenNameIdentifier	 wait Until Listening
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
/* Update the local heartbeat counter. */	TokenNameCOMMENT_BLOCK	 Update the local heartbeat counter. 
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
FBUtilities	TokenNameIdentifier	 FB Utilities
.	TokenNameDOT	
getBroadcastAddress	TokenNameIdentifier	 get Broadcast Address
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
updateHeartBeat	TokenNameIdentifier	 update Heart Beat
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isTraceEnabled	TokenNameIdentifier	 is Trace Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
trace	TokenNameIdentifier	 trace
(	TokenNameLPAREN	
"My heartbeat is now "	TokenNameStringLiteral	My heartbeat is now 
+	TokenNamePLUS	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
FBUtilities	TokenNameIdentifier	 FB Utilities
.	TokenNameDOT	
getBroadcastAddress	TokenNameIdentifier	 get Broadcast Address
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getHeartBeatVersion	TokenNameIdentifier	 get Heart Beat Version
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
final	TokenNamefinal	
List	TokenNameIdentifier	 List
<	TokenNameLESS	
GossipDigest	TokenNameIdentifier	 Gossip Digest
>	TokenNameGREATER	
gDigests	TokenNameIdentifier	 g Digests
=	TokenNameEQUAL	
new	TokenNamenew	
ArrayList	TokenNameIdentifier	 Array List
<	TokenNameLESS	
GossipDigest	TokenNameIdentifier	 Gossip Digest
>	TokenNameGREATER	
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
Gossiper	TokenNameIdentifier	 Gossiper
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
.	TokenNameDOT	
makeRandomGossipDigest	TokenNameIdentifier	 make Random Gossip Digest
(	TokenNameLPAREN	
gDigests	TokenNameIdentifier	 g Digests
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
gDigests	TokenNameIdentifier	 g Digests
.	TokenNameDOT	
size	TokenNameIdentifier	 size
(	TokenNameLPAREN	
)	TokenNameRPAREN	
>	TokenNameGREATER	
0	TokenNameIntegerLiteral	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
GossipDigestSyn	TokenNameIdentifier	 Gossip Digest Syn
digestSynMessage	TokenNameIdentifier	 digest Syn Message
=	TokenNameEQUAL	
new	TokenNamenew	
GossipDigestSyn	TokenNameIdentifier	 Gossip Digest Syn
(	TokenNameLPAREN	
DatabaseDescriptor	TokenNameIdentifier	 Database Descriptor
.	TokenNameDOT	
getClusterName	TokenNameIdentifier	 get Cluster Name
(	TokenNameLPAREN	
)	TokenNameRPAREN	
,	TokenNameCOMMA	
DatabaseDescriptor	TokenNameIdentifier	 Database Descriptor
.	TokenNameDOT	
getPartitionerName	TokenNameIdentifier	 get Partitioner Name
(	TokenNameLPAREN	
)	TokenNameRPAREN	
,	TokenNameCOMMA	
gDigests	TokenNameIdentifier	 g Digests
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
MessageOut	TokenNameIdentifier	 Message Out
<	TokenNameLESS	
GossipDigestSyn	TokenNameIdentifier	 Gossip Digest Syn
>	TokenNameGREATER	
message	TokenNameIdentifier	 message
=	TokenNameEQUAL	
new	TokenNamenew	
MessageOut	TokenNameIdentifier	 Message Out
<	TokenNameLESS	
GossipDigestSyn	TokenNameIdentifier	 Gossip Digest Syn
>	TokenNameGREATER	
(	TokenNameLPAREN	
MessagingService	TokenNameIdentifier	 Messaging Service
.	TokenNameDOT	
Verb	TokenNameIdentifier	 Verb
.	TokenNameDOT	
GOSSIP_DIGEST_SYN	TokenNameIdentifier	 GOSSIP  DIGEST  SYN
,	TokenNameCOMMA	
digestSynMessage	TokenNameIdentifier	 digest Syn Message
,	TokenNameCOMMA	
GossipDigestSyn	TokenNameIdentifier	 Gossip Digest Syn
.	TokenNameDOT	
serializer	TokenNameIdentifier	 serializer
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
/* Gossip to some random live member */	TokenNameCOMMENT_BLOCK	 Gossip to some random live member 
boolean	TokenNameboolean	
gossipedToSeed	TokenNameIdentifier	 gossiped To Seed
=	TokenNameEQUAL	
doGossipToLiveMember	TokenNameIdentifier	 do Gossip To Live Member
(	TokenNameLPAREN	
message	TokenNameIdentifier	 message
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
/* Gossip to some unreachable member with some probability to check if he is back up */	TokenNameCOMMENT_BLOCK	 Gossip to some unreachable member with some probability to check if he is back up 
doGossipToUnreachableMember	TokenNameIdentifier	 do Gossip To Unreachable Member
(	TokenNameLPAREN	
message	TokenNameIdentifier	 message
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
/* Gossip to a seed if we did not do so above, or we have seen less nodes than there are seeds. This prevents partitions where each group of nodes is only gossiping to a subset of the seeds. The most straightforward check would be to check that all the seeds have been verified either as live or unreachable. To avoid that computation each round, we reason that: either all the live nodes are seeds, in which case non-seeds that come online will introduce themselves to a member of the ring by definition, or there is at least one non-seed node in the list, in which case eventually someone will gossip to it, and then do a gossip to a random seed from the gossipedToSeed check. See CASSANDRA-150 for more exposition. */	TokenNameCOMMENT_BLOCK	 Gossip to a seed if we did not do so above, or we have seen less nodes than there are seeds. This prevents partitions where each group of nodes is only gossiping to a subset of the seeds. The most straightforward check would be to check that all the seeds have been verified either as live or unreachable. To avoid that computation each round, we reason that: either all the live nodes are seeds, in which case non-seeds that come online will introduce themselves to a member of the ring by definition, or there is at least one non-seed node in the list, in which case eventually someone will gossip to it, and then do a gossip to a random seed from the gossipedToSeed check. See CASSANDRA-150 for more exposition. 
if	TokenNameif	
(	TokenNameLPAREN	
!	TokenNameNOT	
gossipedToSeed	TokenNameIdentifier	 gossiped To Seed
||	TokenNameOR_OR	
liveEndpoints	TokenNameIdentifier	 live Endpoints
.	TokenNameDOT	
size	TokenNameIdentifier	 size
(	TokenNameLPAREN	
)	TokenNameRPAREN	
<	TokenNameLESS	
seeds	TokenNameIdentifier	 seeds
.	TokenNameDOT	
size	TokenNameIdentifier	 size
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
doGossipToSeed	TokenNameIdentifier	 do Gossip To Seed
(	TokenNameLPAREN	
message	TokenNameIdentifier	 message
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isTraceEnabled	TokenNameIdentifier	 is Trace Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
trace	TokenNameIdentifier	 trace
(	TokenNameLPAREN	
"Performing status check ..."	TokenNameStringLiteral	Performing status check ...
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
doStatusCheck	TokenNameIdentifier	 do Status Check
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
catch	TokenNamecatch	
(	TokenNameLPAREN	
Exception	TokenNameIdentifier	 Exception
e	TokenNameIdentifier	 e
)	TokenNameRPAREN	
{	TokenNameLBRACE	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
error	TokenNameIdentifier	 error
(	TokenNameLPAREN	
"Gossip error"	TokenNameStringLiteral	Gossip error
,	TokenNameCOMMA	
e	TokenNameIdentifier	 e
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
private	TokenNameprivate	
Gossiper	TokenNameIdentifier	 Gossiper
(	TokenNameLPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
// half of QUARATINE_DELAY, to ensure justRemovedEndpoints has enough leeway to prevent re-gossip 	TokenNameCOMMENT_LINE	half of QUARATINE_DELAY, to ensure justRemovedEndpoints has enough leeway to prevent re-gossip 
FatClientTimeout	TokenNameIdentifier	 Fat Client Timeout
=	TokenNameEQUAL	
(	TokenNameLPAREN	
long	TokenNamelong	
)	TokenNameRPAREN	
(	TokenNameLPAREN	
QUARANTINE_DELAY	TokenNameIdentifier	 QUARANTINE  DELAY
/	TokenNameDIVIDE	
2	TokenNameIntegerLiteral	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
/* register with the Failure Detector for receiving Failure detector events */	TokenNameCOMMENT_BLOCK	 register with the Failure Detector for receiving Failure detector events 
FailureDetector	TokenNameIdentifier	 Failure Detector
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
.	TokenNameDOT	
registerFailureDetectionEventListener	TokenNameIdentifier	 register Failure Detection Event Listener
(	TokenNameLPAREN	
this	TokenNamethis	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
// Register this instance with JMX 	TokenNameCOMMENT_LINE	Register this instance with JMX 
try	TokenNametry	
{	TokenNameLBRACE	
MBeanServer	TokenNameIdentifier	 M Bean Server
mbs	TokenNameIdentifier	 mbs
=	TokenNameEQUAL	
ManagementFactory	TokenNameIdentifier	 Management Factory
.	TokenNameDOT	
getPlatformMBeanServer	TokenNameIdentifier	 get Platform M Bean Server
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
mbs	TokenNameIdentifier	 mbs
.	TokenNameDOT	
registerMBean	TokenNameIdentifier	 register M Bean
(	TokenNameLPAREN	
this	TokenNamethis	
,	TokenNameCOMMA	
new	TokenNamenew	
ObjectName	TokenNameIdentifier	 Object Name
(	TokenNameLPAREN	
MBEAN_NAME	TokenNameIdentifier	 MBEAN  NAME
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
catch	TokenNamecatch	
(	TokenNameLPAREN	
Exception	TokenNameIdentifier	 Exception
e	TokenNameIdentifier	 e
)	TokenNameRPAREN	
{	TokenNameLBRACE	
throw	TokenNamethrow	
new	TokenNamenew	
RuntimeException	TokenNameIdentifier	 Runtime Exception
(	TokenNameLPAREN	
e	TokenNameIdentifier	 e
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
/** * Register for interesting state changes. * @param subscriber module which implements the IEndpointStateChangeSubscriber */	TokenNameCOMMENT_JAVADOC	 Register for interesting state changes. @param subscriber module which implements the IEndpointStateChangeSubscriber 
public	TokenNamepublic	
void	TokenNamevoid	
register	TokenNameIdentifier	 register
(	TokenNameLPAREN	
IEndpointStateChangeSubscriber	TokenNameIdentifier	 I Endpoint State Change Subscriber
subscriber	TokenNameIdentifier	 subscriber
)	TokenNameRPAREN	
{	TokenNameLBRACE	
subscribers	TokenNameIdentifier	 subscribers
.	TokenNameDOT	
add	TokenNameIdentifier	 add
(	TokenNameLPAREN	
subscriber	TokenNameIdentifier	 subscriber
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
/** * Unregister interest for state changes. * @param subscriber module which implements the IEndpointStateChangeSubscriber */	TokenNameCOMMENT_JAVADOC	 Unregister interest for state changes. @param subscriber module which implements the IEndpointStateChangeSubscriber 
public	TokenNamepublic	
void	TokenNamevoid	
unregister	TokenNameIdentifier	 unregister
(	TokenNameLPAREN	
IEndpointStateChangeSubscriber	TokenNameIdentifier	 I Endpoint State Change Subscriber
subscriber	TokenNameIdentifier	 subscriber
)	TokenNameRPAREN	
{	TokenNameLBRACE	
subscribers	TokenNameIdentifier	 subscribers
.	TokenNameDOT	
remove	TokenNameIdentifier	 remove
(	TokenNameLPAREN	
subscriber	TokenNameIdentifier	 subscriber
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
public	TokenNamepublic	
Set	TokenNameIdentifier	 Set
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
>	TokenNameGREATER	
getLiveMembers	TokenNameIdentifier	 get Live Members
(	TokenNameLPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
Set	TokenNameIdentifier	 Set
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
>	TokenNameGREATER	
liveMbrs	TokenNameIdentifier	 live Mbrs
=	TokenNameEQUAL	
new	TokenNamenew	
HashSet	TokenNameIdentifier	 Hash Set
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
>	TokenNameGREATER	
(	TokenNameLPAREN	
liveEndpoints	TokenNameIdentifier	 live Endpoints
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
!	TokenNameNOT	
liveMbrs	TokenNameIdentifier	 live Mbrs
.	TokenNameDOT	
contains	TokenNameIdentifier	 contains
(	TokenNameLPAREN	
FBUtilities	TokenNameIdentifier	 FB Utilities
.	TokenNameDOT	
getBroadcastAddress	TokenNameIdentifier	 get Broadcast Address
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
liveMbrs	TokenNameIdentifier	 live Mbrs
.	TokenNameDOT	
add	TokenNameIdentifier	 add
(	TokenNameLPAREN	
FBUtilities	TokenNameIdentifier	 FB Utilities
.	TokenNameDOT	
getBroadcastAddress	TokenNameIdentifier	 get Broadcast Address
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
return	TokenNamereturn	
liveMbrs	TokenNameIdentifier	 live Mbrs
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
public	TokenNamepublic	
Set	TokenNameIdentifier	 Set
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
>	TokenNameGREATER	
getUnreachableMembers	TokenNameIdentifier	 get Unreachable Members
(	TokenNameLPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
return	TokenNamereturn	
unreachableEndpoints	TokenNameIdentifier	 unreachable Endpoints
.	TokenNameDOT	
keySet	TokenNameIdentifier	 key Set
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
public	TokenNamepublic	
long	TokenNamelong	
getEndpointDowntime	TokenNameIdentifier	 get Endpoint Downtime
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
ep	TokenNameIdentifier	 ep
)	TokenNameRPAREN	
{	TokenNameLBRACE	
Long	TokenNameIdentifier	 Long
downtime	TokenNameIdentifier	 downtime
=	TokenNameEQUAL	
unreachableEndpoints	TokenNameIdentifier	 unreachable Endpoints
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
ep	TokenNameIdentifier	 ep
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
downtime	TokenNameIdentifier	 downtime
!=	TokenNameNOT_EQUAL	
null	TokenNamenull	
)	TokenNameRPAREN	
return	TokenNamereturn	
System	TokenNameIdentifier	 System
.	TokenNameDOT	
currentTimeMillis	TokenNameIdentifier	 current Time Millis
(	TokenNameLPAREN	
)	TokenNameRPAREN	
-	TokenNameMINUS	
downtime	TokenNameIdentifier	 downtime
;	TokenNameSEMICOLON	
else	TokenNameelse	
return	TokenNamereturn	
0L	TokenNameLongLiteral	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
/** * This method is part of IFailureDetectionEventListener interface. This is invoked * by the Failure Detector when it convicts an end point. * * @param endpoint end point that is convicted. */	TokenNameCOMMENT_JAVADOC	 This method is part of IFailureDetectionEventListener interface. This is invoked by the Failure Detector when it convicts an end point. * @param endpoint end point that is convicted. 
public	TokenNamepublic	
void	TokenNamevoid	
convict	TokenNameIdentifier	 convict
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
endpoint	TokenNameIdentifier	 endpoint
,	TokenNameCOMMA	
double	TokenNamedouble	
phi	TokenNameIdentifier	 phi
)	TokenNameRPAREN	
{	TokenNameLBRACE	
EndpointState	TokenNameIdentifier	 Endpoint State
epState	TokenNameIdentifier	 ep State
=	TokenNameEQUAL	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
isAlive	TokenNameIdentifier	 is Alive
(	TokenNameLPAREN	
)	TokenNameRPAREN	
&&	TokenNameAND_AND	
!	TokenNameNOT	
isDeadState	TokenNameIdentifier	 is Dead State
(	TokenNameLPAREN	
epState	TokenNameIdentifier	 ep State
)	TokenNameRPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
markDead	TokenNameIdentifier	 mark Dead
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
,	TokenNameCOMMA	
epState	TokenNameIdentifier	 ep State
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
/** * Return either: the greatest heartbeat or application state * @param epState * @return */	TokenNameCOMMENT_JAVADOC	 Return either: the greatest heartbeat or application state @param epState @return 
int	TokenNameint	
getMaxEndpointStateVersion	TokenNameIdentifier	 get Max Endpoint State Version
(	TokenNameLPAREN	
EndpointState	TokenNameIdentifier	 Endpoint State
epState	TokenNameIdentifier	 ep State
)	TokenNameRPAREN	
{	TokenNameLBRACE	
int	TokenNameint	
maxVersion	TokenNameIdentifier	 max Version
=	TokenNameEQUAL	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getHeartBeatVersion	TokenNameIdentifier	 get Heart Beat Version
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
for	TokenNamefor	
(	TokenNameLPAREN	
VersionedValue	TokenNameIdentifier	 Versioned Value
value	TokenNameIdentifier	 value
:	TokenNameCOLON	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
getApplicationStateMap	TokenNameIdentifier	 get Application State Map
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
values	TokenNameIdentifier	 values
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
maxVersion	TokenNameIdentifier	 max Version
=	TokenNameEQUAL	
Math	TokenNameIdentifier	 Math
.	TokenNameDOT	
max	TokenNameIdentifier	 max
(	TokenNameLPAREN	
maxVersion	TokenNameIdentifier	 max Version
,	TokenNameCOMMA	
value	TokenNameIdentifier	 value
.	TokenNameDOT	
version	TokenNameIdentifier	 version
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
return	TokenNamereturn	
maxVersion	TokenNameIdentifier	 max Version
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
/** * Removes the endpoint from gossip completely * * @param endpoint endpoint to be removed from the current membership. */	TokenNameCOMMENT_JAVADOC	 Removes the endpoint from gossip completely * @param endpoint endpoint to be removed from the current membership. 
private	TokenNameprivate	
void	TokenNamevoid	
evictFromMembership	TokenNameIdentifier	 evict From Membership
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
{	TokenNameLBRACE	
unreachableEndpoints	TokenNameIdentifier	 unreachable Endpoints
.	TokenNameDOT	
remove	TokenNameIdentifier	 remove
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
remove	TokenNameIdentifier	 remove
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
expireTimeEndpointMap	TokenNameIdentifier	 expire Time Endpoint Map
.	TokenNameDOT	
remove	TokenNameIdentifier	 remove
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
quarantineEndpoint	TokenNameIdentifier	 quarantine Endpoint
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isDebugEnabled	TokenNameIdentifier	 is Debug Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
debug	TokenNameIdentifier	 debug
(	TokenNameLPAREN	
"evicting "	TokenNameStringLiteral	evicting 
+	TokenNamePLUS	
endpoint	TokenNameIdentifier	 endpoint
+	TokenNamePLUS	
" from gossip"	TokenNameStringLiteral	 from gossip
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
/** * Removes the endpoint from Gossip but retains endpoint state */	TokenNameCOMMENT_JAVADOC	 Removes the endpoint from Gossip but retains endpoint state 
public	TokenNamepublic	
void	TokenNamevoid	
removeEndpoint	TokenNameIdentifier	 remove Endpoint
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
{	TokenNameLBRACE	
// do subscribers first so anything in the subscriber that depends on gossiper state won't get confused 	TokenNameCOMMENT_LINE	do subscribers first so anything in the subscriber that depends on gossiper state won't get confused 
for	TokenNamefor	
(	TokenNameLPAREN	
IEndpointStateChangeSubscriber	TokenNameIdentifier	 I Endpoint State Change Subscriber
subscriber	TokenNameIdentifier	 subscriber
:	TokenNameCOLON	
subscribers	TokenNameIdentifier	 subscribers
)	TokenNameRPAREN	
subscriber	TokenNameIdentifier	 subscriber
.	TokenNameDOT	
onRemove	TokenNameIdentifier	 on Remove
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
liveEndpoints	TokenNameIdentifier	 live Endpoints
.	TokenNameDOT	
remove	TokenNameIdentifier	 remove
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
unreachableEndpoints	TokenNameIdentifier	 unreachable Endpoints
.	TokenNameDOT	
remove	TokenNameIdentifier	 remove
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
// do not remove endpointState until the quarantine expires 	TokenNameCOMMENT_LINE	do not remove endpointState until the quarantine expires 
FailureDetector	TokenNameIdentifier	 Failure Detector
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
.	TokenNameDOT	
remove	TokenNameIdentifier	 remove
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
MessagingService	TokenNameIdentifier	 Messaging Service
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
resetVersion	TokenNameIdentifier	 reset Version
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
quarantineEndpoint	TokenNameIdentifier	 quarantine Endpoint
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
MessagingService	TokenNameIdentifier	 Messaging Service
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
destroyConnectionPool	TokenNameIdentifier	 destroy Connection Pool
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isDebugEnabled	TokenNameIdentifier	 is Debug Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
debug	TokenNameIdentifier	 debug
(	TokenNameLPAREN	
"removing endpoint "	TokenNameStringLiteral	removing endpoint 
+	TokenNamePLUS	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
/** * Quarantines the endpoint for QUARANTINE_DELAY * @param endpoint */	TokenNameCOMMENT_JAVADOC	 Quarantines the endpoint for QUARANTINE_DELAY @param endpoint 
private	TokenNameprivate	
void	TokenNamevoid	
quarantineEndpoint	TokenNameIdentifier	 quarantine Endpoint
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
{	TokenNameLBRACE	
justRemovedEndpoints	TokenNameIdentifier	 just Removed Endpoints
.	TokenNameDOT	
put	TokenNameIdentifier	 put
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
,	TokenNameCOMMA	
System	TokenNameIdentifier	 System
.	TokenNameDOT	
currentTimeMillis	TokenNameIdentifier	 current Time Millis
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
/** * Remove the Endpoint and evict immediately, to avoid gossiping about this node. * This should only be called when a token is taken over by a new IP address. * @param endpoint The endpoint that has been replaced */	TokenNameCOMMENT_JAVADOC	 Remove the Endpoint and evict immediately, to avoid gossiping about this node. This should only be called when a token is taken over by a new IP address. @param endpoint The endpoint that has been replaced 
public	TokenNamepublic	
void	TokenNamevoid	
replacedEndpoint	TokenNameIdentifier	 replaced Endpoint
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
{	TokenNameLBRACE	
removeEndpoint	TokenNameIdentifier	 remove Endpoint
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
evictFromMembership	TokenNameIdentifier	 evict From Membership
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
/** * The gossip digest is built based on randomization * rather than just looping through the collection of live endpoints. * * @param gDigests list of Gossip Digests. */	TokenNameCOMMENT_JAVADOC	 The gossip digest is built based on randomization rather than just looping through the collection of live endpoints. * @param gDigests list of Gossip Digests. 
private	TokenNameprivate	
void	TokenNamevoid	
makeRandomGossipDigest	TokenNameIdentifier	 make Random Gossip Digest
(	TokenNameLPAREN	
List	TokenNameIdentifier	 List
<	TokenNameLESS	
GossipDigest	TokenNameIdentifier	 Gossip Digest
>	TokenNameGREATER	
gDigests	TokenNameIdentifier	 g Digests
)	TokenNameRPAREN	
{	TokenNameLBRACE	
EndpointState	TokenNameIdentifier	 Endpoint State
epState	TokenNameIdentifier	 ep State
;	TokenNameSEMICOLON	
int	TokenNameint	
generation	TokenNameIdentifier	 generation
=	TokenNameEQUAL	
0	TokenNameIntegerLiteral	
;	TokenNameSEMICOLON	
int	TokenNameint	
maxVersion	TokenNameIdentifier	 max Version
=	TokenNameEQUAL	
0	TokenNameIntegerLiteral	
;	TokenNameSEMICOLON	
// local epstate will be part of endpointStateMap 	TokenNameCOMMENT_LINE	local epstate will be part of endpointStateMap 
List	TokenNameIdentifier	 List
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
>	TokenNameGREATER	
endpoints	TokenNameIdentifier	 endpoints
=	TokenNameEQUAL	
new	TokenNamenew	
ArrayList	TokenNameIdentifier	 Array List
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
>	TokenNameGREATER	
(	TokenNameLPAREN	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
keySet	TokenNameIdentifier	 key Set
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
Collections	TokenNameIdentifier	 Collections
.	TokenNameDOT	
shuffle	TokenNameIdentifier	 shuffle
(	TokenNameLPAREN	
endpoints	TokenNameIdentifier	 endpoints
,	TokenNameCOMMA	
random	TokenNameIdentifier	 random
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
for	TokenNamefor	
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
endpoint	TokenNameIdentifier	 endpoint
:	TokenNameCOLON	
endpoints	TokenNameIdentifier	 endpoints
)	TokenNameRPAREN	
{	TokenNameLBRACE	
epState	TokenNameIdentifier	 ep State
=	TokenNameEQUAL	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
epState	TokenNameIdentifier	 ep State
!=	TokenNameNOT_EQUAL	
null	TokenNamenull	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
generation	TokenNameIdentifier	 generation
=	TokenNameEQUAL	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getGeneration	TokenNameIdentifier	 get Generation
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
maxVersion	TokenNameIdentifier	 max Version
=	TokenNameEQUAL	
getMaxEndpointStateVersion	TokenNameIdentifier	 get Max Endpoint State Version
(	TokenNameLPAREN	
epState	TokenNameIdentifier	 ep State
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
gDigests	TokenNameIdentifier	 g Digests
.	TokenNameDOT	
add	TokenNameIdentifier	 add
(	TokenNameLPAREN	
new	TokenNamenew	
GossipDigest	TokenNameIdentifier	 Gossip Digest
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
,	TokenNameCOMMA	
generation	TokenNameIdentifier	 generation
,	TokenNameCOMMA	
maxVersion	TokenNameIdentifier	 max Version
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isTraceEnabled	TokenNameIdentifier	 is Trace Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
StringBuilder	TokenNameIdentifier	 String Builder
sb	TokenNameIdentifier	 sb
=	TokenNameEQUAL	
new	TokenNamenew	
StringBuilder	TokenNameIdentifier	 String Builder
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
for	TokenNamefor	
(	TokenNameLPAREN	
GossipDigest	TokenNameIdentifier	 Gossip Digest
gDigest	TokenNameIdentifier	 g Digest
:	TokenNameCOLON	
gDigests	TokenNameIdentifier	 g Digests
)	TokenNameRPAREN	
{	TokenNameLBRACE	
sb	TokenNameIdentifier	 sb
.	TokenNameDOT	
append	TokenNameIdentifier	 append
(	TokenNameLPAREN	
gDigest	TokenNameIdentifier	 g Digest
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
sb	TokenNameIdentifier	 sb
.	TokenNameDOT	
append	TokenNameIdentifier	 append
(	TokenNameLPAREN	
" "	TokenNameStringLiteral	 
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
trace	TokenNameIdentifier	 trace
(	TokenNameLPAREN	
"Gossip Digests are : "	TokenNameStringLiteral	Gossip Digests are : 
+	TokenNamePLUS	
sb	TokenNameIdentifier	 sb
.	TokenNameDOT	
toString	TokenNameIdentifier	 to String
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
/** * This method will begin removing an existing endpoint from the cluster by spoofing its state * This should never be called unless this coordinator has had 'removetoken' invoked * * @param endpoint - the endpoint being removed * @param hostId - the ID of the host being removed * @param localHostId - my own host ID for replication coordination */	TokenNameCOMMENT_JAVADOC	 This method will begin removing an existing endpoint from the cluster by spoofing its state This should never be called unless this coordinator has had 'removetoken' invoked * @param endpoint - the endpoint being removed @param hostId - the ID of the host being removed @param localHostId - my own host ID for replication coordination 
public	TokenNamepublic	
void	TokenNamevoid	
advertiseRemoving	TokenNameIdentifier	 advertise Removing
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
endpoint	TokenNameIdentifier	 endpoint
,	TokenNameCOMMA	
UUID	TokenNameIdentifier	 UUID
hostId	TokenNameIdentifier	 host Id
,	TokenNameCOMMA	
UUID	TokenNameIdentifier	 UUID
localHostId	TokenNameIdentifier	 local Host Id
)	TokenNameRPAREN	
{	TokenNameLBRACE	
EndpointState	TokenNameIdentifier	 Endpoint State
epState	TokenNameIdentifier	 ep State
=	TokenNameEQUAL	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
// remember this node's generation 	TokenNameCOMMENT_LINE	remember this node's generation 
int	TokenNameint	
generation	TokenNameIdentifier	 generation
=	TokenNameEQUAL	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getGeneration	TokenNameIdentifier	 get Generation
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
info	TokenNameIdentifier	 info
(	TokenNameLPAREN	
"Removing host: {}"	TokenNameStringLiteral	Removing host: {}
,	TokenNameCOMMA	
hostId	TokenNameIdentifier	 host Id
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
info	TokenNameIdentifier	 info
(	TokenNameLPAREN	
"Sleeping for "	TokenNameStringLiteral	Sleeping for 
+	TokenNamePLUS	
StorageService	TokenNameIdentifier	 Storage Service
.	TokenNameDOT	
RING_DELAY	TokenNameIdentifier	 RING  DELAY
+	TokenNamePLUS	
"ms to ensure "	TokenNameStringLiteral	ms to ensure 
+	TokenNamePLUS	
endpoint	TokenNameIdentifier	 endpoint
+	TokenNamePLUS	
" does not change"	TokenNameStringLiteral	 does not change
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
try	TokenNametry	
{	TokenNameLBRACE	
Thread	TokenNameIdentifier	 Thread
.	TokenNameDOT	
sleep	TokenNameIdentifier	 sleep
(	TokenNameLPAREN	
StorageService	TokenNameIdentifier	 Storage Service
.	TokenNameDOT	
RING_DELAY	TokenNameIdentifier	 RING  DELAY
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
catch	TokenNamecatch	
(	TokenNameLPAREN	
InterruptedException	TokenNameIdentifier	 Interrupted Exception
e	TokenNameIdentifier	 e
)	TokenNameRPAREN	
{	TokenNameLBRACE	
throw	TokenNamethrow	
new	TokenNamenew	
AssertionError	TokenNameIdentifier	 Assertion Error
(	TokenNameLPAREN	
e	TokenNameIdentifier	 e
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
// make sure it did not change 	TokenNameCOMMENT_LINE	make sure it did not change 
epState	TokenNameIdentifier	 ep State
=	TokenNameEQUAL	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getGeneration	TokenNameIdentifier	 get Generation
(	TokenNameLPAREN	
)	TokenNameRPAREN	
!=	TokenNameNOT_EQUAL	
generation	TokenNameIdentifier	 generation
)	TokenNameRPAREN	
throw	TokenNamethrow	
new	TokenNamenew	
RuntimeException	TokenNameIdentifier	 Runtime Exception
(	TokenNameLPAREN	
"Endpoint "	TokenNameStringLiteral	Endpoint 
+	TokenNamePLUS	
endpoint	TokenNameIdentifier	 endpoint
+	TokenNamePLUS	
" generation changed while trying to remove it"	TokenNameStringLiteral	 generation changed while trying to remove it
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
// update the other node's generation to mimic it as if it had changed it itself 	TokenNameCOMMENT_LINE	update the other node's generation to mimic it as if it had changed it itself 
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
info	TokenNameIdentifier	 info
(	TokenNameLPAREN	
"Advertising removal for "	TokenNameStringLiteral	Advertising removal for 
+	TokenNamePLUS	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
updateTimestamp	TokenNameIdentifier	 update Timestamp
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
// make sure we don't evict it too soon 	TokenNameCOMMENT_LINE	make sure we don't evict it too soon 
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
forceNewerGenerationUnsafe	TokenNameIdentifier	 force Newer Generation Unsafe
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
addApplicationState	TokenNameIdentifier	 add Application State
(	TokenNameLPAREN	
ApplicationState	TokenNameIdentifier	 Application State
.	TokenNameDOT	
STATUS	TokenNameIdentifier	 STATUS
,	TokenNameCOMMA	
StorageService	TokenNameIdentifier	 Storage Service
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
.	TokenNameDOT	
valueFactory	TokenNameIdentifier	 value Factory
.	TokenNameDOT	
removingNonlocal	TokenNameIdentifier	 removing Nonlocal
(	TokenNameLPAREN	
hostId	TokenNameIdentifier	 host Id
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
addApplicationState	TokenNameIdentifier	 add Application State
(	TokenNameLPAREN	
ApplicationState	TokenNameIdentifier	 Application State
.	TokenNameDOT	
REMOVAL_COORDINATOR	TokenNameIdentifier	 REMOVAL  COORDINATOR
,	TokenNameCOMMA	
StorageService	TokenNameIdentifier	 Storage Service
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
.	TokenNameDOT	
valueFactory	TokenNameIdentifier	 value Factory
.	TokenNameDOT	
removalCoordinator	TokenNameIdentifier	 removal Coordinator
(	TokenNameLPAREN	
localHostId	TokenNameIdentifier	 local Host Id
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
put	TokenNameIdentifier	 put
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
,	TokenNameCOMMA	
epState	TokenNameIdentifier	 ep State
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
/** * Handles switching the endpoint's state from REMOVING_TOKEN to REMOVED_TOKEN * This should only be called after advertiseRemoving * @param endpoint * @param hostId */	TokenNameCOMMENT_JAVADOC	 Handles switching the endpoint's state from REMOVING_TOKEN to REMOVED_TOKEN This should only be called after advertiseRemoving @param endpoint @param hostId 
public	TokenNamepublic	
void	TokenNamevoid	
advertiseTokenRemoved	TokenNameIdentifier	 advertise Token Removed
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
endpoint	TokenNameIdentifier	 endpoint
,	TokenNameCOMMA	
UUID	TokenNameIdentifier	 UUID
hostId	TokenNameIdentifier	 host Id
)	TokenNameRPAREN	
{	TokenNameLBRACE	
EndpointState	TokenNameIdentifier	 Endpoint State
epState	TokenNameIdentifier	 ep State
=	TokenNameEQUAL	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
updateTimestamp	TokenNameIdentifier	 update Timestamp
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
// make sure we don't evict it too soon 	TokenNameCOMMENT_LINE	make sure we don't evict it too soon 
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
forceNewerGenerationUnsafe	TokenNameIdentifier	 force Newer Generation Unsafe
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
addApplicationState	TokenNameIdentifier	 add Application State
(	TokenNameLPAREN	
ApplicationState	TokenNameIdentifier	 Application State
.	TokenNameDOT	
STATUS	TokenNameIdentifier	 STATUS
,	TokenNameCOMMA	
StorageService	TokenNameIdentifier	 Storage Service
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
.	TokenNameDOT	
valueFactory	TokenNameIdentifier	 value Factory
.	TokenNameDOT	
removedNonlocal	TokenNameIdentifier	 removed Nonlocal
(	TokenNameLPAREN	
hostId	TokenNameIdentifier	 host Id
,	TokenNameCOMMA	
computeExpireTime	TokenNameIdentifier	 compute Expire Time
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
info	TokenNameIdentifier	 info
(	TokenNameLPAREN	
"Completing removal of "	TokenNameStringLiteral	Completing removal of 
+	TokenNamePLUS	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
put	TokenNameIdentifier	 put
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
,	TokenNameCOMMA	
epState	TokenNameIdentifier	 ep State
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
// ensure at least one gossip round occurs before returning 	TokenNameCOMMENT_LINE	ensure at least one gossip round occurs before returning 
try	TokenNametry	
{	TokenNameLBRACE	
Thread	TokenNameIdentifier	 Thread
.	TokenNameDOT	
sleep	TokenNameIdentifier	 sleep
(	TokenNameLPAREN	
intervalInMillis	TokenNameIdentifier	 interval In Millis
*	TokenNameMULTIPLY	
2	TokenNameIntegerLiteral	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
catch	TokenNamecatch	
(	TokenNameLPAREN	
InterruptedException	TokenNameIdentifier	 Interrupted Exception
e	TokenNameIdentifier	 e
)	TokenNameRPAREN	
{	TokenNameLBRACE	
throw	TokenNamethrow	
new	TokenNamenew	
AssertionError	TokenNameIdentifier	 Assertion Error
(	TokenNameLPAREN	
e	TokenNameIdentifier	 e
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
/** * Do not call this method unless you know what you are doing. * It will try extremely hard to obliterate any endpoint from the ring, * even if it does not know about it. * This should only ever be called by human via JMX. * @param address * @throws UnknownHostException */	TokenNameCOMMENT_JAVADOC	 Do not call this method unless you know what you are doing. It will try extremely hard to obliterate any endpoint from the ring, even if it does not know about it. This should only ever be called by human via JMX. @param address @throws UnknownHostException 
public	TokenNamepublic	
void	TokenNamevoid	
unsafeAssassinateEndpoint	TokenNameIdentifier	 unsafe Assassinate Endpoint
(	TokenNameLPAREN	
String	TokenNameIdentifier	 String
address	TokenNameIdentifier	 address
)	TokenNameRPAREN	
throws	TokenNamethrows	
UnknownHostException	TokenNameIdentifier	 Unknown Host Exception
{	TokenNameLBRACE	
InetAddress	TokenNameIdentifier	 Inet Address
endpoint	TokenNameIdentifier	 endpoint
=	TokenNameEQUAL	
InetAddress	TokenNameIdentifier	 Inet Address
.	TokenNameDOT	
getByName	TokenNameIdentifier	 get By Name
(	TokenNameLPAREN	
address	TokenNameIdentifier	 address
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
EndpointState	TokenNameIdentifier	 Endpoint State
epState	TokenNameIdentifier	 ep State
=	TokenNameEQUAL	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
Collection	TokenNameIdentifier	 Collection
<	TokenNameLESS	
Token	TokenNameIdentifier	 Token
>	TokenNameGREATER	
tokens	TokenNameIdentifier	 tokens
=	TokenNameEQUAL	
null	TokenNamenull	
;	TokenNameSEMICOLON	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
warn	TokenNameIdentifier	 warn
(	TokenNameLPAREN	
"Assassinating {} via gossip"	TokenNameStringLiteral	Assassinating {} via gossip
,	TokenNameCOMMA	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
epState	TokenNameIdentifier	 ep State
==	TokenNameEQUAL_EQUAL	
null	TokenNamenull	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
epState	TokenNameIdentifier	 ep State
=	TokenNameEQUAL	
new	TokenNamenew	
EndpointState	TokenNameIdentifier	 Endpoint State
(	TokenNameLPAREN	
new	TokenNamenew	
HeartBeatState	TokenNameIdentifier	 Heart Beat State
(	TokenNameLPAREN	
(	TokenNameLPAREN	
int	TokenNameint	
)	TokenNameRPAREN	
(	TokenNameLPAREN	
(	TokenNameLPAREN	
System	TokenNameIdentifier	 System
.	TokenNameDOT	
currentTimeMillis	TokenNameIdentifier	 current Time Millis
(	TokenNameLPAREN	
)	TokenNameRPAREN	
+	TokenNamePLUS	
60000	TokenNameIntegerLiteral	
)	TokenNameRPAREN	
/	TokenNameDIVIDE	
1000	TokenNameIntegerLiteral	
)	TokenNameRPAREN	
,	TokenNameCOMMA	
9999	TokenNameIntegerLiteral	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
else	TokenNameelse	
{	TokenNameLBRACE	
try	TokenNametry	
{	TokenNameLBRACE	
tokens	TokenNameIdentifier	 tokens
=	TokenNameEQUAL	
StorageService	TokenNameIdentifier	 Storage Service
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
.	TokenNameDOT	
getTokenMetadata	TokenNameIdentifier	 get Token Metadata
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getTokens	TokenNameIdentifier	 get Tokens
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
catch	TokenNamecatch	
(	TokenNameLPAREN	
AssertionError	TokenNameIdentifier	 Assertion Error
e	TokenNameIdentifier	 e
)	TokenNameRPAREN	
{	TokenNameLBRACE	
}	TokenNameRBRACE	
int	TokenNameint	
generation	TokenNameIdentifier	 generation
=	TokenNameEQUAL	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getGeneration	TokenNameIdentifier	 get Generation
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
info	TokenNameIdentifier	 info
(	TokenNameLPAREN	
"Sleeping for "	TokenNameStringLiteral	Sleeping for 
+	TokenNamePLUS	
StorageService	TokenNameIdentifier	 Storage Service
.	TokenNameDOT	
RING_DELAY	TokenNameIdentifier	 RING  DELAY
+	TokenNamePLUS	
"ms to ensure "	TokenNameStringLiteral	ms to ensure 
+	TokenNamePLUS	
endpoint	TokenNameIdentifier	 endpoint
+	TokenNamePLUS	
" does not change"	TokenNameStringLiteral	 does not change
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
try	TokenNametry	
{	TokenNameLBRACE	
Thread	TokenNameIdentifier	 Thread
.	TokenNameDOT	
sleep	TokenNameIdentifier	 sleep
(	TokenNameLPAREN	
StorageService	TokenNameIdentifier	 Storage Service
.	TokenNameDOT	
RING_DELAY	TokenNameIdentifier	 RING  DELAY
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
catch	TokenNamecatch	
(	TokenNameLPAREN	
InterruptedException	TokenNameIdentifier	 Interrupted Exception
e	TokenNameIdentifier	 e
)	TokenNameRPAREN	
{	TokenNameLBRACE	
throw	TokenNamethrow	
new	TokenNamenew	
AssertionError	TokenNameIdentifier	 Assertion Error
(	TokenNameLPAREN	
e	TokenNameIdentifier	 e
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
// make sure it did not change 	TokenNameCOMMENT_LINE	make sure it did not change 
epState	TokenNameIdentifier	 ep State
=	TokenNameEQUAL	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getGeneration	TokenNameIdentifier	 get Generation
(	TokenNameLPAREN	
)	TokenNameRPAREN	
!=	TokenNameNOT_EQUAL	
generation	TokenNameIdentifier	 generation
)	TokenNameRPAREN	
throw	TokenNamethrow	
new	TokenNamenew	
RuntimeException	TokenNameIdentifier	 Runtime Exception
(	TokenNameLPAREN	
"Endpoint "	TokenNameStringLiteral	Endpoint 
+	TokenNamePLUS	
endpoint	TokenNameIdentifier	 endpoint
+	TokenNamePLUS	
" generation changed while trying to remove it"	TokenNameStringLiteral	 generation changed while trying to remove it
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
updateTimestamp	TokenNameIdentifier	 update Timestamp
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
// make sure we don't evict it too soon 	TokenNameCOMMENT_LINE	make sure we don't evict it too soon 
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
forceNewerGenerationUnsafe	TokenNameIdentifier	 force Newer Generation Unsafe
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
tokens	TokenNameIdentifier	 tokens
==	TokenNameEQUAL_EQUAL	
null	TokenNamenull	
)	TokenNameRPAREN	
tokens	TokenNameIdentifier	 tokens
=	TokenNameEQUAL	
Arrays	TokenNameIdentifier	 Arrays
.	TokenNameDOT	
asList	TokenNameIdentifier	 as List
(	TokenNameLPAREN	
StorageService	TokenNameIdentifier	 Storage Service
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
.	TokenNameDOT	
getBootstrapToken	TokenNameIdentifier	 get Bootstrap Token
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
// do not pass go, do not collect 200 dollars, just gtfo 	TokenNameCOMMENT_LINE	do not pass go, do not collect 200 dollars, just gtfo 
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
addApplicationState	TokenNameIdentifier	 add Application State
(	TokenNameLPAREN	
ApplicationState	TokenNameIdentifier	 Application State
.	TokenNameDOT	
STATUS	TokenNameIdentifier	 STATUS
,	TokenNameCOMMA	
StorageService	TokenNameIdentifier	 Storage Service
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
.	TokenNameDOT	
valueFactory	TokenNameIdentifier	 value Factory
.	TokenNameDOT	
left	TokenNameIdentifier	 left
(	TokenNameLPAREN	
tokens	TokenNameIdentifier	 tokens
,	TokenNameCOMMA	
computeExpireTime	TokenNameIdentifier	 compute Expire Time
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
handleMajorStateChange	TokenNameIdentifier	 handle Major State Change
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
,	TokenNameCOMMA	
epState	TokenNameIdentifier	 ep State
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
try	TokenNametry	
{	TokenNameLBRACE	
Thread	TokenNameIdentifier	 Thread
.	TokenNameDOT	
sleep	TokenNameIdentifier	 sleep
(	TokenNameLPAREN	
intervalInMillis	TokenNameIdentifier	 interval In Millis
*	TokenNameMULTIPLY	
4	TokenNameIntegerLiteral	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
catch	TokenNamecatch	
(	TokenNameLPAREN	
InterruptedException	TokenNameIdentifier	 Interrupted Exception
e	TokenNameIdentifier	 e
)	TokenNameRPAREN	
{	TokenNameLBRACE	
throw	TokenNamethrow	
new	TokenNamenew	
AssertionError	TokenNameIdentifier	 Assertion Error
(	TokenNameLPAREN	
e	TokenNameIdentifier	 e
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
warn	TokenNameIdentifier	 warn
(	TokenNameLPAREN	
"Finished killing {}"	TokenNameStringLiteral	Finished killing {}
,	TokenNameCOMMA	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
public	TokenNamepublic	
boolean	TokenNameboolean	
isKnownEndpoint	TokenNameIdentifier	 is Known Endpoint
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
{	TokenNameLBRACE	
return	TokenNamereturn	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
containsKey	TokenNameIdentifier	 contains Key
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
public	TokenNamepublic	
int	TokenNameint	
getCurrentGenerationNumber	TokenNameIdentifier	 get Current Generation Number
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
{	TokenNameLBRACE	
return	TokenNamereturn	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getGeneration	TokenNameIdentifier	 get Generation
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
/** * Returns true if the chosen target was also a seed. False otherwise * * * @param message * @param epSet a set of endpoint from which a random endpoint is chosen. * @return true if the chosen endpoint is also a seed. */	TokenNameCOMMENT_JAVADOC	 Returns true if the chosen target was also a seed. False otherwise * @param message @param epSet a set of endpoint from which a random endpoint is chosen. @return true if the chosen endpoint is also a seed. 
private	TokenNameprivate	
boolean	TokenNameboolean	
sendGossip	TokenNameIdentifier	 send Gossip
(	TokenNameLPAREN	
MessageOut	TokenNameIdentifier	 Message Out
<	TokenNameLESS	
GossipDigestSyn	TokenNameIdentifier	 Gossip Digest Syn
>	TokenNameGREATER	
message	TokenNameIdentifier	 message
,	TokenNameCOMMA	
Set	TokenNameIdentifier	 Set
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
>	TokenNameGREATER	
epSet	TokenNameIdentifier	 ep Set
)	TokenNameRPAREN	
{	TokenNameLBRACE	
int	TokenNameint	
size	TokenNameIdentifier	 size
=	TokenNameEQUAL	
epSet	TokenNameIdentifier	 ep Set
.	TokenNameDOT	
size	TokenNameIdentifier	 size
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
size	TokenNameIdentifier	 size
<	TokenNameLESS	
1	TokenNameIntegerLiteral	
)	TokenNameRPAREN	
return	TokenNamereturn	
false	TokenNamefalse	
;	TokenNameSEMICOLON	
/* Generate a random number from 0 -> size */	TokenNameCOMMENT_BLOCK	 Generate a random number from 0 -> size 
List	TokenNameIdentifier	 List
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
>	TokenNameGREATER	
liveEndpoints	TokenNameIdentifier	 live Endpoints
=	TokenNameEQUAL	
new	TokenNamenew	
ArrayList	TokenNameIdentifier	 Array List
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
>	TokenNameGREATER	
(	TokenNameLPAREN	
epSet	TokenNameIdentifier	 ep Set
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
int	TokenNameint	
index	TokenNameIdentifier	 index
=	TokenNameEQUAL	
(	TokenNameLPAREN	
size	TokenNameIdentifier	 size
==	TokenNameEQUAL_EQUAL	
1	TokenNameIntegerLiteral	
)	TokenNameRPAREN	
?	TokenNameQUESTION	
0	TokenNameIntegerLiteral	
:	TokenNameCOLON	
random	TokenNameIdentifier	 random
.	TokenNameDOT	
nextInt	TokenNameIdentifier	 next Int
(	TokenNameLPAREN	
size	TokenNameIdentifier	 size
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
InetAddress	TokenNameIdentifier	 Inet Address
to	TokenNameIdentifier	 to
=	TokenNameEQUAL	
liveEndpoints	TokenNameIdentifier	 live Endpoints
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
index	TokenNameIdentifier	 index
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isTraceEnabled	TokenNameIdentifier	 is Trace Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
trace	TokenNameIdentifier	 trace
(	TokenNameLPAREN	
"Sending a GossipDigestSyn to {} ..."	TokenNameStringLiteral	Sending a GossipDigestSyn to {} ...
,	TokenNameCOMMA	
to	TokenNameIdentifier	 to
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
MessagingService	TokenNameIdentifier	 Messaging Service
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
sendOneWay	TokenNameIdentifier	 send One Way
(	TokenNameLPAREN	
message	TokenNameIdentifier	 message
,	TokenNameCOMMA	
to	TokenNameIdentifier	 to
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
return	TokenNamereturn	
seeds	TokenNameIdentifier	 seeds
.	TokenNameDOT	
contains	TokenNameIdentifier	 contains
(	TokenNameLPAREN	
to	TokenNameIdentifier	 to
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
/* Sends a Gossip message to a live member and returns true if the recipient was a seed */	TokenNameCOMMENT_BLOCK	 Sends a Gossip message to a live member and returns true if the recipient was a seed 
private	TokenNameprivate	
boolean	TokenNameboolean	
doGossipToLiveMember	TokenNameIdentifier	 do Gossip To Live Member
(	TokenNameLPAREN	
MessageOut	TokenNameIdentifier	 Message Out
<	TokenNameLESS	
GossipDigestSyn	TokenNameIdentifier	 Gossip Digest Syn
>	TokenNameGREATER	
message	TokenNameIdentifier	 message
)	TokenNameRPAREN	
{	TokenNameLBRACE	
int	TokenNameint	
size	TokenNameIdentifier	 size
=	TokenNameEQUAL	
liveEndpoints	TokenNameIdentifier	 live Endpoints
.	TokenNameDOT	
size	TokenNameIdentifier	 size
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
size	TokenNameIdentifier	 size
==	TokenNameEQUAL_EQUAL	
0	TokenNameIntegerLiteral	
)	TokenNameRPAREN	
return	TokenNamereturn	
false	TokenNamefalse	
;	TokenNameSEMICOLON	
return	TokenNamereturn	
sendGossip	TokenNameIdentifier	 send Gossip
(	TokenNameLPAREN	
message	TokenNameIdentifier	 message
,	TokenNameCOMMA	
liveEndpoints	TokenNameIdentifier	 live Endpoints
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
/* Sends a Gossip message to an unreachable member */	TokenNameCOMMENT_BLOCK	 Sends a Gossip message to an unreachable member 
private	TokenNameprivate	
void	TokenNamevoid	
doGossipToUnreachableMember	TokenNameIdentifier	 do Gossip To Unreachable Member
(	TokenNameLPAREN	
MessageOut	TokenNameIdentifier	 Message Out
<	TokenNameLESS	
GossipDigestSyn	TokenNameIdentifier	 Gossip Digest Syn
>	TokenNameGREATER	
message	TokenNameIdentifier	 message
)	TokenNameRPAREN	
{	TokenNameLBRACE	
double	TokenNamedouble	
liveEndpointCount	TokenNameIdentifier	 live Endpoint Count
=	TokenNameEQUAL	
liveEndpoints	TokenNameIdentifier	 live Endpoints
.	TokenNameDOT	
size	TokenNameIdentifier	 size
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
double	TokenNamedouble	
unreachableEndpointCount	TokenNameIdentifier	 unreachable Endpoint Count
=	TokenNameEQUAL	
unreachableEndpoints	TokenNameIdentifier	 unreachable Endpoints
.	TokenNameDOT	
size	TokenNameIdentifier	 size
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
unreachableEndpointCount	TokenNameIdentifier	 unreachable Endpoint Count
>	TokenNameGREATER	
0	TokenNameIntegerLiteral	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
/* based on some probability */	TokenNameCOMMENT_BLOCK	 based on some probability 
double	TokenNamedouble	
prob	TokenNameIdentifier	 prob
=	TokenNameEQUAL	
unreachableEndpointCount	TokenNameIdentifier	 unreachable Endpoint Count
/	TokenNameDIVIDE	
(	TokenNameLPAREN	
liveEndpointCount	TokenNameIdentifier	 live Endpoint Count
+	TokenNamePLUS	
1	TokenNameIntegerLiteral	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
double	TokenNamedouble	
randDbl	TokenNameIdentifier	 rand Dbl
=	TokenNameEQUAL	
random	TokenNameIdentifier	 random
.	TokenNameDOT	
nextDouble	TokenNameIdentifier	 next Double
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
randDbl	TokenNameIdentifier	 rand Dbl
<	TokenNameLESS	
prob	TokenNameIdentifier	 prob
)	TokenNameRPAREN	
sendGossip	TokenNameIdentifier	 send Gossip
(	TokenNameLPAREN	
message	TokenNameIdentifier	 message
,	TokenNameCOMMA	
unreachableEndpoints	TokenNameIdentifier	 unreachable Endpoints
.	TokenNameDOT	
keySet	TokenNameIdentifier	 key Set
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
/* Gossip to a seed for facilitating partition healing */	TokenNameCOMMENT_BLOCK	 Gossip to a seed for facilitating partition healing 
private	TokenNameprivate	
void	TokenNamevoid	
doGossipToSeed	TokenNameIdentifier	 do Gossip To Seed
(	TokenNameLPAREN	
MessageOut	TokenNameIdentifier	 Message Out
<	TokenNameLESS	
GossipDigestSyn	TokenNameIdentifier	 Gossip Digest Syn
>	TokenNameGREATER	
prod	TokenNameIdentifier	 prod
)	TokenNameRPAREN	
{	TokenNameLBRACE	
int	TokenNameint	
size	TokenNameIdentifier	 size
=	TokenNameEQUAL	
seeds	TokenNameIdentifier	 seeds
.	TokenNameDOT	
size	TokenNameIdentifier	 size
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
size	TokenNameIdentifier	 size
>	TokenNameGREATER	
0	TokenNameIntegerLiteral	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
size	TokenNameIdentifier	 size
==	TokenNameEQUAL_EQUAL	
1	TokenNameIntegerLiteral	
&&	TokenNameAND_AND	
seeds	TokenNameIdentifier	 seeds
.	TokenNameDOT	
contains	TokenNameIdentifier	 contains
(	TokenNameLPAREN	
FBUtilities	TokenNameIdentifier	 FB Utilities
.	TokenNameDOT	
getBroadcastAddress	TokenNameIdentifier	 get Broadcast Address
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
return	TokenNamereturn	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
liveEndpoints	TokenNameIdentifier	 live Endpoints
.	TokenNameDOT	
size	TokenNameIdentifier	 size
(	TokenNameLPAREN	
)	TokenNameRPAREN	
==	TokenNameEQUAL_EQUAL	
0	TokenNameIntegerLiteral	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
sendGossip	TokenNameIdentifier	 send Gossip
(	TokenNameLPAREN	
prod	TokenNameIdentifier	 prod
,	TokenNameCOMMA	
seeds	TokenNameIdentifier	 seeds
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
else	TokenNameelse	
{	TokenNameLBRACE	
/* Gossip with the seed with some probability. */	TokenNameCOMMENT_BLOCK	 Gossip with the seed with some probability. 
double	TokenNamedouble	
probability	TokenNameIdentifier	 probability
=	TokenNameEQUAL	
seeds	TokenNameIdentifier	 seeds
.	TokenNameDOT	
size	TokenNameIdentifier	 size
(	TokenNameLPAREN	
)	TokenNameRPAREN	
/	TokenNameDIVIDE	
(	TokenNameLPAREN	
double	TokenNamedouble	
)	TokenNameRPAREN	
(	TokenNameLPAREN	
liveEndpoints	TokenNameIdentifier	 live Endpoints
.	TokenNameDOT	
size	TokenNameIdentifier	 size
(	TokenNameLPAREN	
)	TokenNameRPAREN	
+	TokenNamePLUS	
unreachableEndpoints	TokenNameIdentifier	 unreachable Endpoints
.	TokenNameDOT	
size	TokenNameIdentifier	 size
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
double	TokenNamedouble	
randDbl	TokenNameIdentifier	 rand Dbl
=	TokenNameEQUAL	
random	TokenNameIdentifier	 random
.	TokenNameDOT	
nextDouble	TokenNameIdentifier	 next Double
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
randDbl	TokenNameIdentifier	 rand Dbl
<=	TokenNameLESS_EQUAL	
probability	TokenNameIdentifier	 probability
)	TokenNameRPAREN	
sendGossip	TokenNameIdentifier	 send Gossip
(	TokenNameLPAREN	
prod	TokenNameIdentifier	 prod
,	TokenNameCOMMA	
seeds	TokenNameIdentifier	 seeds
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
private	TokenNameprivate	
void	TokenNamevoid	
doStatusCheck	TokenNameIdentifier	 do Status Check
(	TokenNameLPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
long	TokenNamelong	
now	TokenNameIdentifier	 now
=	TokenNameEQUAL	
System	TokenNameIdentifier	 System
.	TokenNameDOT	
currentTimeMillis	TokenNameIdentifier	 current Time Millis
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
Set	TokenNameIdentifier	 Set
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
>	TokenNameGREATER	
eps	TokenNameIdentifier	 eps
=	TokenNameEQUAL	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
keySet	TokenNameIdentifier	 key Set
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
for	TokenNamefor	
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
endpoint	TokenNameIdentifier	 endpoint
:	TokenNameCOLON	
eps	TokenNameIdentifier	 eps
)	TokenNameRPAREN	
{	TokenNameLBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
.	TokenNameDOT	
equals	TokenNameIdentifier	 equals
(	TokenNameLPAREN	
FBUtilities	TokenNameIdentifier	 FB Utilities
.	TokenNameDOT	
getBroadcastAddress	TokenNameIdentifier	 get Broadcast Address
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
continue	TokenNamecontinue	
;	TokenNameSEMICOLON	
FailureDetector	TokenNameIdentifier	 Failure Detector
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
.	TokenNameDOT	
interpret	TokenNameIdentifier	 interpret
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
EndpointState	TokenNameIdentifier	 Endpoint State
epState	TokenNameIdentifier	 ep State
=	TokenNameEQUAL	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
epState	TokenNameIdentifier	 ep State
!=	TokenNameNOT_EQUAL	
null	TokenNamenull	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
long	TokenNamelong	
duration	TokenNameIdentifier	 duration
=	TokenNameEQUAL	
now	TokenNameIdentifier	 now
-	TokenNameMINUS	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
getUpdateTimestamp	TokenNameIdentifier	 get Update Timestamp
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
// check if this is a fat client. fat clients are removed automatically from 	TokenNameCOMMENT_LINE	check if this is a fat client. fat clients are removed automatically from 
// gossip after FatClientTimeout. Do not remove dead states here. 	TokenNameCOMMENT_LINE	gossip after FatClientTimeout. Do not remove dead states here. 
if	TokenNameif	
(	TokenNameLPAREN	
!	TokenNameNOT	
isDeadState	TokenNameIdentifier	 is Dead State
(	TokenNameLPAREN	
epState	TokenNameIdentifier	 ep State
)	TokenNameRPAREN	
&&	TokenNameAND_AND	
!	TokenNameNOT	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
isAlive	TokenNameIdentifier	 is Alive
(	TokenNameLPAREN	
)	TokenNameRPAREN	
&&	TokenNameAND_AND	
!	TokenNameNOT	
StorageService	TokenNameIdentifier	 Storage Service
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
.	TokenNameDOT	
getTokenMetadata	TokenNameIdentifier	 get Token Metadata
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
isMember	TokenNameIdentifier	 is Member
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
&&	TokenNameAND_AND	
!	TokenNameNOT	
justRemovedEndpoints	TokenNameIdentifier	 just Removed Endpoints
.	TokenNameDOT	
containsKey	TokenNameIdentifier	 contains Key
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
&&	TokenNameAND_AND	
(	TokenNameLPAREN	
duration	TokenNameIdentifier	 duration
>	TokenNameGREATER	
FatClientTimeout	TokenNameIdentifier	 Fat Client Timeout
)	TokenNameRPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
info	TokenNameIdentifier	 info
(	TokenNameLPAREN	
"FatClient "	TokenNameStringLiteral	FatClient 
+	TokenNamePLUS	
endpoint	TokenNameIdentifier	 endpoint
+	TokenNamePLUS	
" has been silent for "	TokenNameStringLiteral	 has been silent for 
+	TokenNamePLUS	
FatClientTimeout	TokenNameIdentifier	 Fat Client Timeout
+	TokenNamePLUS	
"ms, removing from gossip"	TokenNameStringLiteral	ms, removing from gossip
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
removeEndpoint	TokenNameIdentifier	 remove Endpoint
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
// will put it in justRemovedEndpoints to respect quarantine delay 	TokenNameCOMMENT_LINE	will put it in justRemovedEndpoints to respect quarantine delay 
evictFromMembership	TokenNameIdentifier	 evict From Membership
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
// can get rid of the state immediately 	TokenNameCOMMENT_LINE	can get rid of the state immediately 
}	TokenNameRBRACE	
// check for dead state removal 	TokenNameCOMMENT_LINE	check for dead state removal 
long	TokenNamelong	
expireTime	TokenNameIdentifier	 expire Time
=	TokenNameEQUAL	
getExpireTimeForEndpoint	TokenNameIdentifier	 get Expire Time For Endpoint
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
!	TokenNameNOT	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
isAlive	TokenNameIdentifier	 is Alive
(	TokenNameLPAREN	
)	TokenNameRPAREN	
&&	TokenNameAND_AND	
(	TokenNameLPAREN	
now	TokenNameIdentifier	 now
>	TokenNameGREATER	
expireTime	TokenNameIdentifier	 expire Time
)	TokenNameRPAREN	
&&	TokenNameAND_AND	
(	TokenNameLPAREN	
!	TokenNameNOT	
StorageService	TokenNameIdentifier	 Storage Service
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
.	TokenNameDOT	
getTokenMetadata	TokenNameIdentifier	 get Token Metadata
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
isMember	TokenNameIdentifier	 is Member
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isDebugEnabled	TokenNameIdentifier	 is Debug Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
debug	TokenNameIdentifier	 debug
(	TokenNameLPAREN	
"time is expiring for endpoint : "	TokenNameStringLiteral	time is expiring for endpoint : 
+	TokenNamePLUS	
endpoint	TokenNameIdentifier	 endpoint
+	TokenNamePLUS	
" ("	TokenNameStringLiteral	 (
+	TokenNamePLUS	
expireTime	TokenNameIdentifier	 expire Time
+	TokenNamePLUS	
")"	TokenNameStringLiteral	)
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
evictFromMembership	TokenNameIdentifier	 evict From Membership
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
!	TokenNameNOT	
justRemovedEndpoints	TokenNameIdentifier	 just Removed Endpoints
.	TokenNameDOT	
isEmpty	TokenNameIdentifier	 is Empty
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
for	TokenNamefor	
(	TokenNameLPAREN	
Entry	TokenNameIdentifier	 Entry
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
,	TokenNameCOMMA	
Long	TokenNameIdentifier	 Long
>	TokenNameGREATER	
entry	TokenNameIdentifier	 entry
:	TokenNameCOLON	
justRemovedEndpoints	TokenNameIdentifier	 just Removed Endpoints
.	TokenNameDOT	
entrySet	TokenNameIdentifier	 entry Set
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
(	TokenNameLPAREN	
now	TokenNameIdentifier	 now
-	TokenNameMINUS	
entry	TokenNameIdentifier	 entry
.	TokenNameDOT	
getValue	TokenNameIdentifier	 get Value
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
>	TokenNameGREATER	
QUARANTINE_DELAY	TokenNameIdentifier	 QUARANTINE  DELAY
)	TokenNameRPAREN	
{	TokenNameLBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isDebugEnabled	TokenNameIdentifier	 is Debug Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
debug	TokenNameIdentifier	 debug
(	TokenNameLPAREN	
QUARANTINE_DELAY	TokenNameIdentifier	 QUARANTINE  DELAY
+	TokenNamePLUS	
" elapsed, "	TokenNameStringLiteral	 elapsed, 
+	TokenNamePLUS	
entry	TokenNameIdentifier	 entry
.	TokenNameDOT	
getKey	TokenNameIdentifier	 get Key
(	TokenNameLPAREN	
)	TokenNameRPAREN	
+	TokenNamePLUS	
" gossip quarantine over"	TokenNameStringLiteral	 gossip quarantine over
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
justRemovedEndpoints	TokenNameIdentifier	 just Removed Endpoints
.	TokenNameDOT	
remove	TokenNameIdentifier	 remove
(	TokenNameLPAREN	
entry	TokenNameIdentifier	 entry
.	TokenNameDOT	
getKey	TokenNameIdentifier	 get Key
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
protected	TokenNameprotected	
long	TokenNamelong	
getExpireTimeForEndpoint	TokenNameIdentifier	 get Expire Time For Endpoint
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
{	TokenNameLBRACE	
/* default expireTime is aVeryLongTime */	TokenNameCOMMENT_BLOCK	 default expireTime is aVeryLongTime 
Long	TokenNameIdentifier	 Long
storedTime	TokenNameIdentifier	 stored Time
=	TokenNameEQUAL	
expireTimeEndpointMap	TokenNameIdentifier	 expire Time Endpoint Map
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
return	TokenNamereturn	
storedTime	TokenNameIdentifier	 stored Time
==	TokenNameEQUAL_EQUAL	
null	TokenNamenull	
?	TokenNameQUESTION	
computeExpireTime	TokenNameIdentifier	 compute Expire Time
(	TokenNameLPAREN	
)	TokenNameRPAREN	
:	TokenNameCOLON	
storedTime	TokenNameIdentifier	 stored Time
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
public	TokenNamepublic	
EndpointState	TokenNameIdentifier	 Endpoint State
getEndpointStateForEndpoint	TokenNameIdentifier	 get Endpoint State For Endpoint
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
ep	TokenNameIdentifier	 ep
)	TokenNameRPAREN	
{	TokenNameLBRACE	
return	TokenNamereturn	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
ep	TokenNameIdentifier	 ep
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
public	TokenNamepublic	
Set	TokenNameIdentifier	 Set
<	TokenNameLESS	
Entry	TokenNameIdentifier	 Entry
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
,	TokenNameCOMMA	
EndpointState	TokenNameIdentifier	 Endpoint State
>>	TokenNameRIGHT_SHIFT	
getEndpointStates	TokenNameIdentifier	 get Endpoint States
(	TokenNameLPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
return	TokenNamereturn	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
entrySet	TokenNameIdentifier	 entry Set
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
public	TokenNamepublic	
boolean	TokenNameboolean	
usesHostId	TokenNameIdentifier	 uses Host Id
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
{	TokenNameLBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
MessagingService	TokenNameIdentifier	 Messaging Service
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
knowsVersion	TokenNameIdentifier	 knows Version
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
&&	TokenNameAND_AND	
MessagingService	TokenNameIdentifier	 Messaging Service
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getVersion	TokenNameIdentifier	 get Version
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
>=	TokenNameGREATER_EQUAL	
MessagingService	TokenNameIdentifier	 Messaging Service
.	TokenNameDOT	
VERSION_12	TokenNameIdentifier	 VERSION 12
)	TokenNameRPAREN	
return	TokenNamereturn	
true	TokenNametrue	
;	TokenNameSEMICOLON	
else	TokenNameelse	
if	TokenNameif	
(	TokenNameLPAREN	
getEndpointStateForEndpoint	TokenNameIdentifier	 get Endpoint State For Endpoint
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
.	TokenNameDOT	
getApplicationState	TokenNameIdentifier	 get Application State
(	TokenNameLPAREN	
ApplicationState	TokenNameIdentifier	 Application State
.	TokenNameDOT	
NET_VERSION	TokenNameIdentifier	 NET  VERSION
)	TokenNameRPAREN	
!=	TokenNameNOT_EQUAL	
null	TokenNamenull	
&&	TokenNameAND_AND	
Integer	TokenNameIdentifier	 Integer
.	TokenNameDOT	
parseInt	TokenNameIdentifier	 parse Int
(	TokenNameLPAREN	
getEndpointStateForEndpoint	TokenNameIdentifier	 get Endpoint State For Endpoint
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
.	TokenNameDOT	
getApplicationState	TokenNameIdentifier	 get Application State
(	TokenNameLPAREN	
ApplicationState	TokenNameIdentifier	 Application State
.	TokenNameDOT	
NET_VERSION	TokenNameIdentifier	 NET  VERSION
)	TokenNameRPAREN	
.	TokenNameDOT	
value	TokenNameIdentifier	 value
)	TokenNameRPAREN	
>=	TokenNameGREATER_EQUAL	
MessagingService	TokenNameIdentifier	 Messaging Service
.	TokenNameDOT	
VERSION_12	TokenNameIdentifier	 VERSION 12
)	TokenNameRPAREN	
return	TokenNamereturn	
true	TokenNametrue	
;	TokenNameSEMICOLON	
return	TokenNamereturn	
false	TokenNamefalse	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
public	TokenNamepublic	
UUID	TokenNameIdentifier	 UUID
getHostId	TokenNameIdentifier	 get Host Id
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
{	TokenNameLBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
!	TokenNameNOT	
usesHostId	TokenNameIdentifier	 uses Host Id
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
)	TokenNameRPAREN	
throw	TokenNamethrow	
new	TokenNamenew	
RuntimeException	TokenNameIdentifier	 Runtime Exception
(	TokenNameLPAREN	
"Host "	TokenNameStringLiteral	Host 
+	TokenNamePLUS	
endpoint	TokenNameIdentifier	 endpoint
+	TokenNamePLUS	
" does not use new-style tokens!"	TokenNameStringLiteral	 does not use new-style tokens!
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
return	TokenNamereturn	
UUID	TokenNameIdentifier	 UUID
.	TokenNameDOT	
fromString	TokenNameIdentifier	 from String
(	TokenNameLPAREN	
getEndpointStateForEndpoint	TokenNameIdentifier	 get Endpoint State For Endpoint
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
.	TokenNameDOT	
getApplicationState	TokenNameIdentifier	 get Application State
(	TokenNameLPAREN	
ApplicationState	TokenNameIdentifier	 Application State
.	TokenNameDOT	
HOST_ID	TokenNameIdentifier	 HOST  ID
)	TokenNameRPAREN	
.	TokenNameDOT	
value	TokenNameIdentifier	 value
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
EndpointState	TokenNameIdentifier	 Endpoint State
getStateForVersionBiggerThan	TokenNameIdentifier	 get State For Version Bigger Than
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
forEndpoint	TokenNameIdentifier	 for Endpoint
,	TokenNameCOMMA	
int	TokenNameint	
version	TokenNameIdentifier	 version
)	TokenNameRPAREN	
{	TokenNameLBRACE	
EndpointState	TokenNameIdentifier	 Endpoint State
epState	TokenNameIdentifier	 ep State
=	TokenNameEQUAL	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
forEndpoint	TokenNameIdentifier	 for Endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
EndpointState	TokenNameIdentifier	 Endpoint State
reqdEndpointState	TokenNameIdentifier	 reqd Endpoint State
=	TokenNameEQUAL	
null	TokenNamenull	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
epState	TokenNameIdentifier	 ep State
!=	TokenNameNOT_EQUAL	
null	TokenNamenull	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
/* * Here we try to include the Heart Beat state only if it is * greater than the version passed in. It might happen that * the heart beat version maybe lesser than the version passed * in and some application state has a version that is greater * than the version passed in. In this case we also send the old * heart beat and throw it away on the receiver if it is redundant. */	TokenNameCOMMENT_BLOCK	 Here we try to include the Heart Beat state only if it is greater than the version passed in. It might happen that the heart beat version maybe lesser than the version passed in and some application state has a version that is greater than the version passed in. In this case we also send the old heart beat and throw it away on the receiver if it is redundant. 
int	TokenNameint	
localHbVersion	TokenNameIdentifier	 local Hb Version
=	TokenNameEQUAL	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getHeartBeatVersion	TokenNameIdentifier	 get Heart Beat Version
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
localHbVersion	TokenNameIdentifier	 local Hb Version
>	TokenNameGREATER	
version	TokenNameIdentifier	 version
)	TokenNameRPAREN	
{	TokenNameLBRACE	
reqdEndpointState	TokenNameIdentifier	 reqd Endpoint State
=	TokenNameEQUAL	
new	TokenNamenew	
EndpointState	TokenNameIdentifier	 Endpoint State
(	TokenNameLPAREN	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isTraceEnabled	TokenNameIdentifier	 is Trace Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
trace	TokenNameIdentifier	 trace
(	TokenNameLPAREN	
"local heartbeat version "	TokenNameStringLiteral	local heartbeat version 
+	TokenNamePLUS	
localHbVersion	TokenNameIdentifier	 local Hb Version
+	TokenNamePLUS	
" greater than "	TokenNameStringLiteral	 greater than 
+	TokenNamePLUS	
version	TokenNameIdentifier	 version
+	TokenNamePLUS	
" for "	TokenNameStringLiteral	 for 
+	TokenNamePLUS	
forEndpoint	TokenNameIdentifier	 for Endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
/* Accumulate all application states whose versions are greater than "version" variable */	TokenNameCOMMENT_BLOCK	 Accumulate all application states whose versions are greater than "version" variable 
for	TokenNamefor	
(	TokenNameLPAREN	
Entry	TokenNameIdentifier	 Entry
<	TokenNameLESS	
ApplicationState	TokenNameIdentifier	 Application State
,	TokenNameCOMMA	
VersionedValue	TokenNameIdentifier	 Versioned Value
>	TokenNameGREATER	
entry	TokenNameIdentifier	 entry
:	TokenNameCOLON	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
getApplicationStateMap	TokenNameIdentifier	 get Application State Map
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
entrySet	TokenNameIdentifier	 entry Set
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
VersionedValue	TokenNameIdentifier	 Versioned Value
value	TokenNameIdentifier	 value
=	TokenNameEQUAL	
entry	TokenNameIdentifier	 entry
.	TokenNameDOT	
getValue	TokenNameIdentifier	 get Value
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
value	TokenNameIdentifier	 value
.	TokenNameDOT	
version	TokenNameIdentifier	 version
>	TokenNameGREATER	
version	TokenNameIdentifier	 version
)	TokenNameRPAREN	
{	TokenNameLBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
reqdEndpointState	TokenNameIdentifier	 reqd Endpoint State
==	TokenNameEQUAL_EQUAL	
null	TokenNamenull	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
reqdEndpointState	TokenNameIdentifier	 reqd Endpoint State
=	TokenNameEQUAL	
new	TokenNamenew	
EndpointState	TokenNameIdentifier	 Endpoint State
(	TokenNameLPAREN	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
final	TokenNamefinal	
ApplicationState	TokenNameIdentifier	 Application State
key	TokenNameIdentifier	 key
=	TokenNameEQUAL	
entry	TokenNameIdentifier	 entry
.	TokenNameDOT	
getKey	TokenNameIdentifier	 get Key
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isTraceEnabled	TokenNameIdentifier	 is Trace Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
trace	TokenNameIdentifier	 trace
(	TokenNameLPAREN	
"Adding state "	TokenNameStringLiteral	Adding state 
+	TokenNamePLUS	
key	TokenNameIdentifier	 key
+	TokenNamePLUS	
": "	TokenNameStringLiteral	: 
+	TokenNamePLUS	
value	TokenNameIdentifier	 value
.	TokenNameDOT	
value	TokenNameIdentifier	 value
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
reqdEndpointState	TokenNameIdentifier	 reqd Endpoint State
.	TokenNameDOT	
addApplicationState	TokenNameIdentifier	 add Application State
(	TokenNameLPAREN	
key	TokenNameIdentifier	 key
,	TokenNameCOMMA	
value	TokenNameIdentifier	 value
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
return	TokenNamereturn	
reqdEndpointState	TokenNameIdentifier	 reqd Endpoint State
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
/** determine which endpoint started up earlier */	TokenNameCOMMENT_JAVADOC	 determine which endpoint started up earlier 
public	TokenNamepublic	
int	TokenNameint	
compareEndpointStartup	TokenNameIdentifier	 compare Endpoint Startup
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
addr1	TokenNameIdentifier	 addr1
,	TokenNameCOMMA	
InetAddress	TokenNameIdentifier	 Inet Address
addr2	TokenNameIdentifier	 addr2
)	TokenNameRPAREN	
{	TokenNameLBRACE	
EndpointState	TokenNameIdentifier	 Endpoint State
ep1	TokenNameIdentifier	 ep1
=	TokenNameEQUAL	
getEndpointStateForEndpoint	TokenNameIdentifier	 get Endpoint State For Endpoint
(	TokenNameLPAREN	
addr1	TokenNameIdentifier	 addr1
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
EndpointState	TokenNameIdentifier	 Endpoint State
ep2	TokenNameIdentifier	 ep2
=	TokenNameEQUAL	
getEndpointStateForEndpoint	TokenNameIdentifier	 get Endpoint State For Endpoint
(	TokenNameLPAREN	
addr2	TokenNameIdentifier	 addr2
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
assert	TokenNameassert	
ep1	TokenNameIdentifier	 ep1
!=	TokenNameNOT_EQUAL	
null	TokenNamenull	
&&	TokenNameAND_AND	
ep2	TokenNameIdentifier	 ep2
!=	TokenNameNOT_EQUAL	
null	TokenNamenull	
;	TokenNameSEMICOLON	
return	TokenNamereturn	
ep1	TokenNameIdentifier	 ep1
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getGeneration	TokenNameIdentifier	 get Generation
(	TokenNameLPAREN	
)	TokenNameRPAREN	
-	TokenNameMINUS	
ep2	TokenNameIdentifier	 ep2
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getGeneration	TokenNameIdentifier	 get Generation
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
void	TokenNamevoid	
notifyFailureDetector	TokenNameIdentifier	 notify Failure Detector
(	TokenNameLPAREN	
List	TokenNameIdentifier	 List
<	TokenNameLESS	
GossipDigest	TokenNameIdentifier	 Gossip Digest
>	TokenNameGREATER	
gDigests	TokenNameIdentifier	 g Digests
)	TokenNameRPAREN	
{	TokenNameLBRACE	
for	TokenNamefor	
(	TokenNameLPAREN	
GossipDigest	TokenNameIdentifier	 Gossip Digest
gDigest	TokenNameIdentifier	 g Digest
:	TokenNameCOLON	
gDigests	TokenNameIdentifier	 g Digests
)	TokenNameRPAREN	
{	TokenNameLBRACE	
notifyFailureDetector	TokenNameIdentifier	 notify Failure Detector
(	TokenNameLPAREN	
gDigest	TokenNameIdentifier	 g Digest
.	TokenNameDOT	
endpoint	TokenNameIdentifier	 endpoint
,	TokenNameCOMMA	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
gDigest	TokenNameIdentifier	 g Digest
.	TokenNameDOT	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
void	TokenNamevoid	
notifyFailureDetector	TokenNameIdentifier	 notify Failure Detector
(	TokenNameLPAREN	
Map	TokenNameIdentifier	 Map
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
,	TokenNameCOMMA	
EndpointState	TokenNameIdentifier	 Endpoint State
>	TokenNameGREATER	
remoteEpStateMap	TokenNameIdentifier	 remote Ep State Map
)	TokenNameRPAREN	
{	TokenNameLBRACE	
for	TokenNamefor	
(	TokenNameLPAREN	
Entry	TokenNameIdentifier	 Entry
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
,	TokenNameCOMMA	
EndpointState	TokenNameIdentifier	 Endpoint State
>	TokenNameGREATER	
entry	TokenNameIdentifier	 entry
:	TokenNameCOLON	
remoteEpStateMap	TokenNameIdentifier	 remote Ep State Map
.	TokenNameDOT	
entrySet	TokenNameIdentifier	 entry Set
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
notifyFailureDetector	TokenNameIdentifier	 notify Failure Detector
(	TokenNameLPAREN	
entry	TokenNameIdentifier	 entry
.	TokenNameDOT	
getKey	TokenNameIdentifier	 get Key
(	TokenNameLPAREN	
)	TokenNameRPAREN	
,	TokenNameCOMMA	
entry	TokenNameIdentifier	 entry
.	TokenNameDOT	
getValue	TokenNameIdentifier	 get Value
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
void	TokenNamevoid	
notifyFailureDetector	TokenNameIdentifier	 notify Failure Detector
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
endpoint	TokenNameIdentifier	 endpoint
,	TokenNameCOMMA	
EndpointState	TokenNameIdentifier	 Endpoint State
remoteEndpointState	TokenNameIdentifier	 remote Endpoint State
)	TokenNameRPAREN	
{	TokenNameLBRACE	
EndpointState	TokenNameIdentifier	 Endpoint State
localEndpointState	TokenNameIdentifier	 local Endpoint State
=	TokenNameEQUAL	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
/* * If the local endpoint state exists then report to the FD only * if the versions workout. */	TokenNameCOMMENT_BLOCK	 If the local endpoint state exists then report to the FD only if the versions workout. 
if	TokenNameif	
(	TokenNameLPAREN	
localEndpointState	TokenNameIdentifier	 local Endpoint State
!=	TokenNameNOT_EQUAL	
null	TokenNamenull	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
IFailureDetector	TokenNameIdentifier	 I Failure Detector
fd	TokenNameIdentifier	 fd
=	TokenNameEQUAL	
FailureDetector	TokenNameIdentifier	 Failure Detector
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
;	TokenNameSEMICOLON	
int	TokenNameint	
localGeneration	TokenNameIdentifier	 local Generation
=	TokenNameEQUAL	
localEndpointState	TokenNameIdentifier	 local Endpoint State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getGeneration	TokenNameIdentifier	 get Generation
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
int	TokenNameint	
remoteGeneration	TokenNameIdentifier	 remote Generation
=	TokenNameEQUAL	
remoteEndpointState	TokenNameIdentifier	 remote Endpoint State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getGeneration	TokenNameIdentifier	 get Generation
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
remoteGeneration	TokenNameIdentifier	 remote Generation
>	TokenNameGREATER	
localGeneration	TokenNameIdentifier	 local Generation
)	TokenNameRPAREN	
{	TokenNameLBRACE	
localEndpointState	TokenNameIdentifier	 local Endpoint State
.	TokenNameDOT	
updateTimestamp	TokenNameIdentifier	 update Timestamp
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
// this node was dead and the generation changed, this indicates a reboot, or possibly a takeover 	TokenNameCOMMENT_LINE	this node was dead and the generation changed, this indicates a reboot, or possibly a takeover 
// we will clean the fd intervals for it and relearn them 	TokenNameCOMMENT_LINE	we will clean the fd intervals for it and relearn them 
if	TokenNameif	
(	TokenNameLPAREN	
!	TokenNameNOT	
localEndpointState	TokenNameIdentifier	 local Endpoint State
.	TokenNameDOT	
isAlive	TokenNameIdentifier	 is Alive
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
debug	TokenNameIdentifier	 debug
(	TokenNameLPAREN	
"Clearing interval times for {} due to generation change"	TokenNameStringLiteral	Clearing interval times for {} due to generation change
,	TokenNameCOMMA	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
fd	TokenNameIdentifier	 fd
.	TokenNameDOT	
clear	TokenNameIdentifier	 clear
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
fd	TokenNameIdentifier	 fd
.	TokenNameDOT	
report	TokenNameIdentifier	 report
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
return	TokenNamereturn	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
remoteGeneration	TokenNameIdentifier	 remote Generation
==	TokenNameEQUAL_EQUAL	
localGeneration	TokenNameIdentifier	 local Generation
)	TokenNameRPAREN	
{	TokenNameLBRACE	
int	TokenNameint	
localVersion	TokenNameIdentifier	 local Version
=	TokenNameEQUAL	
getMaxEndpointStateVersion	TokenNameIdentifier	 get Max Endpoint State Version
(	TokenNameLPAREN	
localEndpointState	TokenNameIdentifier	 local Endpoint State
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
int	TokenNameint	
remoteVersion	TokenNameIdentifier	 remote Version
=	TokenNameEQUAL	
remoteEndpointState	TokenNameIdentifier	 remote Endpoint State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getHeartBeatVersion	TokenNameIdentifier	 get Heart Beat Version
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
remoteVersion	TokenNameIdentifier	 remote Version
>	TokenNameGREATER	
localVersion	TokenNameIdentifier	 local Version
)	TokenNameRPAREN	
{	TokenNameLBRACE	
localEndpointState	TokenNameIdentifier	 local Endpoint State
.	TokenNameDOT	
updateTimestamp	TokenNameIdentifier	 update Timestamp
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
// just a version change, report to the fd 	TokenNameCOMMENT_LINE	just a version change, report to the fd 
fd	TokenNameIdentifier	 fd
.	TokenNameDOT	
report	TokenNameIdentifier	 report
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
private	TokenNameprivate	
void	TokenNamevoid	
markAlive	TokenNameIdentifier	 mark Alive
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
addr	TokenNameIdentifier	 addr
,	TokenNameCOMMA	
EndpointState	TokenNameIdentifier	 Endpoint State
localState	TokenNameIdentifier	 local State
)	TokenNameRPAREN	
{	TokenNameLBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isTraceEnabled	TokenNameIdentifier	 is Trace Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
trace	TokenNameIdentifier	 trace
(	TokenNameLPAREN	
"marking as alive {}"	TokenNameStringLiteral	marking as alive {}
,	TokenNameCOMMA	
addr	TokenNameIdentifier	 addr
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
localState	TokenNameIdentifier	 local State
.	TokenNameDOT	
markAlive	TokenNameIdentifier	 mark Alive
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
localState	TokenNameIdentifier	 local State
.	TokenNameDOT	
updateTimestamp	TokenNameIdentifier	 update Timestamp
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
// prevents doStatusCheck from racing us and evicting if it was down > aVeryLongTime 	TokenNameCOMMENT_LINE	prevents doStatusCheck from racing us and evicting if it was down > aVeryLongTime 
liveEndpoints	TokenNameIdentifier	 live Endpoints
.	TokenNameDOT	
add	TokenNameIdentifier	 add
(	TokenNameLPAREN	
addr	TokenNameIdentifier	 addr
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
unreachableEndpoints	TokenNameIdentifier	 unreachable Endpoints
.	TokenNameDOT	
remove	TokenNameIdentifier	 remove
(	TokenNameLPAREN	
addr	TokenNameIdentifier	 addr
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
expireTimeEndpointMap	TokenNameIdentifier	 expire Time Endpoint Map
.	TokenNameDOT	
remove	TokenNameIdentifier	 remove
(	TokenNameLPAREN	
addr	TokenNameIdentifier	 addr
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
debug	TokenNameIdentifier	 debug
(	TokenNameLPAREN	
"removing expire time for endpoint : "	TokenNameStringLiteral	removing expire time for endpoint : 
+	TokenNamePLUS	
addr	TokenNameIdentifier	 addr
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
info	TokenNameIdentifier	 info
(	TokenNameLPAREN	
"InetAddress {} is now UP"	TokenNameStringLiteral	InetAddress {} is now UP
,	TokenNameCOMMA	
addr	TokenNameIdentifier	 addr
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
for	TokenNamefor	
(	TokenNameLPAREN	
IEndpointStateChangeSubscriber	TokenNameIdentifier	 I Endpoint State Change Subscriber
subscriber	TokenNameIdentifier	 subscriber
:	TokenNameCOLON	
subscribers	TokenNameIdentifier	 subscribers
)	TokenNameRPAREN	
subscriber	TokenNameIdentifier	 subscriber
.	TokenNameDOT	
onAlive	TokenNameIdentifier	 on Alive
(	TokenNameLPAREN	
addr	TokenNameIdentifier	 addr
,	TokenNameCOMMA	
localState	TokenNameIdentifier	 local State
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isTraceEnabled	TokenNameIdentifier	 is Trace Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
trace	TokenNameIdentifier	 trace
(	TokenNameLPAREN	
"Notified "	TokenNameStringLiteral	Notified 
+	TokenNamePLUS	
subscribers	TokenNameIdentifier	 subscribers
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
private	TokenNameprivate	
void	TokenNamevoid	
markDead	TokenNameIdentifier	 mark Dead
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
addr	TokenNameIdentifier	 addr
,	TokenNameCOMMA	
EndpointState	TokenNameIdentifier	 Endpoint State
localState	TokenNameIdentifier	 local State
)	TokenNameRPAREN	
{	TokenNameLBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isTraceEnabled	TokenNameIdentifier	 is Trace Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
trace	TokenNameIdentifier	 trace
(	TokenNameLPAREN	
"marking as dead {}"	TokenNameStringLiteral	marking as dead {}
,	TokenNameCOMMA	
addr	TokenNameIdentifier	 addr
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
localState	TokenNameIdentifier	 local State
.	TokenNameDOT	
markDead	TokenNameIdentifier	 mark Dead
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
liveEndpoints	TokenNameIdentifier	 live Endpoints
.	TokenNameDOT	
remove	TokenNameIdentifier	 remove
(	TokenNameLPAREN	
addr	TokenNameIdentifier	 addr
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
unreachableEndpoints	TokenNameIdentifier	 unreachable Endpoints
.	TokenNameDOT	
put	TokenNameIdentifier	 put
(	TokenNameLPAREN	
addr	TokenNameIdentifier	 addr
,	TokenNameCOMMA	
System	TokenNameIdentifier	 System
.	TokenNameDOT	
currentTimeMillis	TokenNameIdentifier	 current Time Millis
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
info	TokenNameIdentifier	 info
(	TokenNameLPAREN	
"InetAddress {} is now dead."	TokenNameStringLiteral	InetAddress {} is now dead.
,	TokenNameCOMMA	
addr	TokenNameIdentifier	 addr
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
for	TokenNamefor	
(	TokenNameLPAREN	
IEndpointStateChangeSubscriber	TokenNameIdentifier	 I Endpoint State Change Subscriber
subscriber	TokenNameIdentifier	 subscriber
:	TokenNameCOLON	
subscribers	TokenNameIdentifier	 subscribers
)	TokenNameRPAREN	
subscriber	TokenNameIdentifier	 subscriber
.	TokenNameDOT	
onDead	TokenNameIdentifier	 on Dead
(	TokenNameLPAREN	
addr	TokenNameIdentifier	 addr
,	TokenNameCOMMA	
localState	TokenNameIdentifier	 local State
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isTraceEnabled	TokenNameIdentifier	 is Trace Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
trace	TokenNameIdentifier	 trace
(	TokenNameLPAREN	
"Notified "	TokenNameStringLiteral	Notified 
+	TokenNamePLUS	
subscribers	TokenNameIdentifier	 subscribers
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
/** * This method is called whenever there is a "big" change in ep state (a generation change for a known node). * * @param ep endpoint * @param epState EndpointState for the endpoint */	TokenNameCOMMENT_JAVADOC	 This method is called whenever there is a "big" change in ep state (a generation change for a known node). * @param ep endpoint @param epState EndpointState for the endpoint 
private	TokenNameprivate	
void	TokenNamevoid	
handleMajorStateChange	TokenNameIdentifier	 handle Major State Change
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
ep	TokenNameIdentifier	 ep
,	TokenNameCOMMA	
EndpointState	TokenNameIdentifier	 Endpoint State
epState	TokenNameIdentifier	 ep State
)	TokenNameRPAREN	
{	TokenNameLBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
!	TokenNameNOT	
isDeadState	TokenNameIdentifier	 is Dead State
(	TokenNameLPAREN	
epState	TokenNameIdentifier	 ep State
)	TokenNameRPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
ep	TokenNameIdentifier	 ep
)	TokenNameRPAREN	
!=	TokenNameNOT_EQUAL	
null	TokenNamenull	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
info	TokenNameIdentifier	 info
(	TokenNameLPAREN	
"Node {} has restarted, now UP"	TokenNameStringLiteral	Node {} has restarted, now UP
,	TokenNameCOMMA	
ep	TokenNameIdentifier	 ep
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
else	TokenNameelse	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
info	TokenNameIdentifier	 info
(	TokenNameLPAREN	
"Node {} is now part of the cluster"	TokenNameStringLiteral	Node {} is now part of the cluster
,	TokenNameCOMMA	
ep	TokenNameIdentifier	 ep
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isTraceEnabled	TokenNameIdentifier	 is Trace Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
trace	TokenNameIdentifier	 trace
(	TokenNameLPAREN	
"Adding endpoint state for "	TokenNameStringLiteral	Adding endpoint state for 
+	TokenNamePLUS	
ep	TokenNameIdentifier	 ep
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
put	TokenNameIdentifier	 put
(	TokenNameLPAREN	
ep	TokenNameIdentifier	 ep
,	TokenNameCOMMA	
epState	TokenNameIdentifier	 ep State
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
// the node restarted: it is up to the subscriber to take whatever action is necessary 	TokenNameCOMMENT_LINE	the node restarted: it is up to the subscriber to take whatever action is necessary 
for	TokenNamefor	
(	TokenNameLPAREN	
IEndpointStateChangeSubscriber	TokenNameIdentifier	 I Endpoint State Change Subscriber
subscriber	TokenNameIdentifier	 subscriber
:	TokenNameCOLON	
subscribers	TokenNameIdentifier	 subscribers
)	TokenNameRPAREN	
subscriber	TokenNameIdentifier	 subscriber
.	TokenNameDOT	
onRestart	TokenNameIdentifier	 on Restart
(	TokenNameLPAREN	
ep	TokenNameIdentifier	 ep
,	TokenNameCOMMA	
epState	TokenNameIdentifier	 ep State
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
!	TokenNameNOT	
isDeadState	TokenNameIdentifier	 is Dead State
(	TokenNameLPAREN	
epState	TokenNameIdentifier	 ep State
)	TokenNameRPAREN	
)	TokenNameRPAREN	
markAlive	TokenNameIdentifier	 mark Alive
(	TokenNameLPAREN	
ep	TokenNameIdentifier	 ep
,	TokenNameCOMMA	
epState	TokenNameIdentifier	 ep State
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
else	TokenNameelse	
{	TokenNameLBRACE	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
debug	TokenNameIdentifier	 debug
(	TokenNameLPAREN	
"Not marking "	TokenNameStringLiteral	Not marking 
+	TokenNamePLUS	
ep	TokenNameIdentifier	 ep
+	TokenNamePLUS	
" alive due to dead state"	TokenNameStringLiteral	 alive due to dead state
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
markDead	TokenNameIdentifier	 mark Dead
(	TokenNameLPAREN	
ep	TokenNameIdentifier	 ep
,	TokenNameCOMMA	
epState	TokenNameIdentifier	 ep State
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
for	TokenNamefor	
(	TokenNameLPAREN	
IEndpointStateChangeSubscriber	TokenNameIdentifier	 I Endpoint State Change Subscriber
subscriber	TokenNameIdentifier	 subscriber
:	TokenNameCOLON	
subscribers	TokenNameIdentifier	 subscribers
)	TokenNameRPAREN	
subscriber	TokenNameIdentifier	 subscriber
.	TokenNameDOT	
onJoin	TokenNameIdentifier	 on Join
(	TokenNameLPAREN	
ep	TokenNameIdentifier	 ep
,	TokenNameCOMMA	
epState	TokenNameIdentifier	 ep State
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
private	TokenNameprivate	
Boolean	TokenNameIdentifier	 Boolean
isDeadState	TokenNameIdentifier	 is Dead State
(	TokenNameLPAREN	
EndpointState	TokenNameIdentifier	 Endpoint State
epState	TokenNameIdentifier	 ep State
)	TokenNameRPAREN	
{	TokenNameLBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
getApplicationState	TokenNameIdentifier	 get Application State
(	TokenNameLPAREN	
ApplicationState	TokenNameIdentifier	 Application State
.	TokenNameDOT	
STATUS	TokenNameIdentifier	 STATUS
)	TokenNameRPAREN	
==	TokenNameEQUAL_EQUAL	
null	TokenNamenull	
)	TokenNameRPAREN	
return	TokenNamereturn	
false	TokenNamefalse	
;	TokenNameSEMICOLON	
String	TokenNameIdentifier	 String
value	TokenNameIdentifier	 value
=	TokenNameEQUAL	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
getApplicationState	TokenNameIdentifier	 get Application State
(	TokenNameLPAREN	
ApplicationState	TokenNameIdentifier	 Application State
.	TokenNameDOT	
STATUS	TokenNameIdentifier	 STATUS
)	TokenNameRPAREN	
.	TokenNameDOT	
value	TokenNameIdentifier	 value
;	TokenNameSEMICOLON	
String	TokenNameIdentifier	 String
[	TokenNameLBRACKET	
]	TokenNameRBRACKET	
pieces	TokenNameIdentifier	 pieces
=	TokenNameEQUAL	
value	TokenNameIdentifier	 value
.	TokenNameDOT	
split	TokenNameIdentifier	 split
(	TokenNameLPAREN	
VersionedValue	TokenNameIdentifier	 Versioned Value
.	TokenNameDOT	
DELIMITER_STR	TokenNameIdentifier	 DELIMITER  STR
,	TokenNameCOMMA	
-	TokenNameMINUS	
1	TokenNameIntegerLiteral	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
assert	TokenNameassert	
(	TokenNameLPAREN	
pieces	TokenNameIdentifier	 pieces
.	TokenNameDOT	
length	TokenNameIdentifier	 length
>	TokenNameGREATER	
0	TokenNameIntegerLiteral	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
String	TokenNameIdentifier	 String
state	TokenNameIdentifier	 state
=	TokenNameEQUAL	
pieces	TokenNameIdentifier	 pieces
[	TokenNameLBRACKET	
0	TokenNameIntegerLiteral	
]	TokenNameRBRACKET	
;	TokenNameSEMICOLON	
for	TokenNamefor	
(	TokenNameLPAREN	
String	TokenNameIdentifier	 String
deadstate	TokenNameIdentifier	 deadstate
:	TokenNameCOLON	
DEAD_STATES	TokenNameIdentifier	 DEAD  STATES
)	TokenNameRPAREN	
{	TokenNameLBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
state	TokenNameIdentifier	 state
.	TokenNameDOT	
equals	TokenNameIdentifier	 equals
(	TokenNameLPAREN	
deadstate	TokenNameIdentifier	 deadstate
)	TokenNameRPAREN	
)	TokenNameRPAREN	
return	TokenNamereturn	
true	TokenNametrue	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
return	TokenNamereturn	
false	TokenNamefalse	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
void	TokenNamevoid	
applyStateLocally	TokenNameIdentifier	 apply State Locally
(	TokenNameLPAREN	
Map	TokenNameIdentifier	 Map
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
,	TokenNameCOMMA	
EndpointState	TokenNameIdentifier	 Endpoint State
>	TokenNameGREATER	
epStateMap	TokenNameIdentifier	 ep State Map
)	TokenNameRPAREN	
{	TokenNameLBRACE	
for	TokenNamefor	
(	TokenNameLPAREN	
Entry	TokenNameIdentifier	 Entry
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
,	TokenNameCOMMA	
EndpointState	TokenNameIdentifier	 Endpoint State
>	TokenNameGREATER	
entry	TokenNameIdentifier	 entry
:	TokenNameCOLON	
epStateMap	TokenNameIdentifier	 ep State Map
.	TokenNameDOT	
entrySet	TokenNameIdentifier	 entry Set
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
InetAddress	TokenNameIdentifier	 Inet Address
ep	TokenNameIdentifier	 ep
=	TokenNameEQUAL	
entry	TokenNameIdentifier	 entry
.	TokenNameDOT	
getKey	TokenNameIdentifier	 get Key
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
ep	TokenNameIdentifier	 ep
.	TokenNameDOT	
equals	TokenNameIdentifier	 equals
(	TokenNameLPAREN	
FBUtilities	TokenNameIdentifier	 FB Utilities
.	TokenNameDOT	
getBroadcastAddress	TokenNameIdentifier	 get Broadcast Address
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
continue	TokenNamecontinue	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
justRemovedEndpoints	TokenNameIdentifier	 just Removed Endpoints
.	TokenNameDOT	
containsKey	TokenNameIdentifier	 contains Key
(	TokenNameLPAREN	
ep	TokenNameIdentifier	 ep
)	TokenNameRPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isTraceEnabled	TokenNameIdentifier	 is Trace Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
trace	TokenNameIdentifier	 trace
(	TokenNameLPAREN	
"Ignoring gossip for "	TokenNameStringLiteral	Ignoring gossip for 
+	TokenNamePLUS	
ep	TokenNameIdentifier	 ep
+	TokenNamePLUS	
" because it is quarantined"	TokenNameStringLiteral	 because it is quarantined
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
continue	TokenNamecontinue	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
EndpointState	TokenNameIdentifier	 Endpoint State
localEpStatePtr	TokenNameIdentifier	 local Ep State Ptr
=	TokenNameEQUAL	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
ep	TokenNameIdentifier	 ep
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
EndpointState	TokenNameIdentifier	 Endpoint State
remoteState	TokenNameIdentifier	 remote State
=	TokenNameEQUAL	
entry	TokenNameIdentifier	 entry
.	TokenNameDOT	
getValue	TokenNameIdentifier	 get Value
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
/* If state does not exist just add it. If it does then add it if the remote generation is greater. If there is a generation tie, attempt to break it by heartbeat version. */	TokenNameCOMMENT_BLOCK	 If state does not exist just add it. If it does then add it if the remote generation is greater. If there is a generation tie, attempt to break it by heartbeat version. 
if	TokenNameif	
(	TokenNameLPAREN	
localEpStatePtr	TokenNameIdentifier	 local Ep State Ptr
!=	TokenNameNOT_EQUAL	
null	TokenNamenull	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
int	TokenNameint	
localGeneration	TokenNameIdentifier	 local Generation
=	TokenNameEQUAL	
localEpStatePtr	TokenNameIdentifier	 local Ep State Ptr
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getGeneration	TokenNameIdentifier	 get Generation
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
int	TokenNameint	
remoteGeneration	TokenNameIdentifier	 remote Generation
=	TokenNameEQUAL	
remoteState	TokenNameIdentifier	 remote State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getGeneration	TokenNameIdentifier	 get Generation
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isTraceEnabled	TokenNameIdentifier	 is Trace Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
trace	TokenNameIdentifier	 trace
(	TokenNameLPAREN	
ep	TokenNameIdentifier	 ep
+	TokenNamePLUS	
"local generation "	TokenNameStringLiteral	local generation 
+	TokenNamePLUS	
localGeneration	TokenNameIdentifier	 local Generation
+	TokenNamePLUS	
", remote generation "	TokenNameStringLiteral	, remote generation 
+	TokenNamePLUS	
remoteGeneration	TokenNameIdentifier	 remote Generation
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
remoteGeneration	TokenNameIdentifier	 remote Generation
>	TokenNameGREATER	
localGeneration	TokenNameIdentifier	 local Generation
)	TokenNameRPAREN	
{	TokenNameLBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isTraceEnabled	TokenNameIdentifier	 is Trace Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
trace	TokenNameIdentifier	 trace
(	TokenNameLPAREN	
"Updating heartbeat state generation to "	TokenNameStringLiteral	Updating heartbeat state generation to 
+	TokenNamePLUS	
remoteGeneration	TokenNameIdentifier	 remote Generation
+	TokenNamePLUS	
" from "	TokenNameStringLiteral	 from 
+	TokenNamePLUS	
localGeneration	TokenNameIdentifier	 local Generation
+	TokenNamePLUS	
" for "	TokenNameStringLiteral	 for 
+	TokenNamePLUS	
ep	TokenNameIdentifier	 ep
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
// major state change will handle the update by inserting the remote state directly 	TokenNameCOMMENT_LINE	major state change will handle the update by inserting the remote state directly 
handleMajorStateChange	TokenNameIdentifier	 handle Major State Change
(	TokenNameLPAREN	
ep	TokenNameIdentifier	 ep
,	TokenNameCOMMA	
remoteState	TokenNameIdentifier	 remote State
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
else	TokenNameelse	
if	TokenNameif	
(	TokenNameLPAREN	
remoteGeneration	TokenNameIdentifier	 remote Generation
==	TokenNameEQUAL_EQUAL	
localGeneration	TokenNameIdentifier	 local Generation
)	TokenNameRPAREN	
// generation has not changed, apply new states 	TokenNameCOMMENT_LINE	generation has not changed, apply new states 
{	TokenNameLBRACE	
/* find maximum state */	TokenNameCOMMENT_BLOCK	 find maximum state 
int	TokenNameint	
localMaxVersion	TokenNameIdentifier	 local Max Version
=	TokenNameEQUAL	
getMaxEndpointStateVersion	TokenNameIdentifier	 get Max Endpoint State Version
(	TokenNameLPAREN	
localEpStatePtr	TokenNameIdentifier	 local Ep State Ptr
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
int	TokenNameint	
remoteMaxVersion	TokenNameIdentifier	 remote Max Version
=	TokenNameEQUAL	
getMaxEndpointStateVersion	TokenNameIdentifier	 get Max Endpoint State Version
(	TokenNameLPAREN	
remoteState	TokenNameIdentifier	 remote State
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
remoteMaxVersion	TokenNameIdentifier	 remote Max Version
>	TokenNameGREATER	
localMaxVersion	TokenNameIdentifier	 local Max Version
)	TokenNameRPAREN	
{	TokenNameLBRACE	
// apply states, but do not notify since there is no major change 	TokenNameCOMMENT_LINE	apply states, but do not notify since there is no major change 
applyNewStates	TokenNameIdentifier	 apply New States
(	TokenNameLPAREN	
ep	TokenNameIdentifier	 ep
,	TokenNameCOMMA	
localEpStatePtr	TokenNameIdentifier	 local Ep State Ptr
,	TokenNameCOMMA	
remoteState	TokenNameIdentifier	 remote State
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
else	TokenNameelse	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isTraceEnabled	TokenNameIdentifier	 is Trace Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
trace	TokenNameIdentifier	 trace
(	TokenNameLPAREN	
"Ignoring remote version "	TokenNameStringLiteral	Ignoring remote version 
+	TokenNamePLUS	
remoteMaxVersion	TokenNameIdentifier	 remote Max Version
+	TokenNamePLUS	
" <= "	TokenNameStringLiteral	 <= 
+	TokenNamePLUS	
localMaxVersion	TokenNameIdentifier	 local Max Version
+	TokenNamePLUS	
" for "	TokenNameStringLiteral	 for 
+	TokenNamePLUS	
ep	TokenNameIdentifier	 ep
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
!	TokenNameNOT	
localEpStatePtr	TokenNameIdentifier	 local Ep State Ptr
.	TokenNameDOT	
isAlive	TokenNameIdentifier	 is Alive
(	TokenNameLPAREN	
)	TokenNameRPAREN	
&&	TokenNameAND_AND	
!	TokenNameNOT	
isDeadState	TokenNameIdentifier	 is Dead State
(	TokenNameLPAREN	
localEpStatePtr	TokenNameIdentifier	 local Ep State Ptr
)	TokenNameRPAREN	
)	TokenNameRPAREN	
// unless of course, it was dead 	TokenNameCOMMENT_LINE	unless of course, it was dead 
markAlive	TokenNameIdentifier	 mark Alive
(	TokenNameLPAREN	
ep	TokenNameIdentifier	 ep
,	TokenNameCOMMA	
localEpStatePtr	TokenNameIdentifier	 local Ep State Ptr
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
else	TokenNameelse	
{	TokenNameLBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isTraceEnabled	TokenNameIdentifier	 is Trace Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
trace	TokenNameIdentifier	 trace
(	TokenNameLPAREN	
"Ignoring remote generation "	TokenNameStringLiteral	Ignoring remote generation 
+	TokenNamePLUS	
remoteGeneration	TokenNameIdentifier	 remote Generation
+	TokenNamePLUS	
" < "	TokenNameStringLiteral	 < 
+	TokenNamePLUS	
localGeneration	TokenNameIdentifier	 local Generation
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
else	TokenNameelse	
{	TokenNameLBRACE	
// this is a new node, report it to the FD in case it is the first time we are seeing it AND it's not alive 	TokenNameCOMMENT_LINE	this is a new node, report it to the FD in case it is the first time we are seeing it AND it's not alive 
FailureDetector	TokenNameIdentifier	 Failure Detector
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
.	TokenNameDOT	
report	TokenNameIdentifier	 report
(	TokenNameLPAREN	
ep	TokenNameIdentifier	 ep
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
handleMajorStateChange	TokenNameIdentifier	 handle Major State Change
(	TokenNameLPAREN	
ep	TokenNameIdentifier	 ep
,	TokenNameCOMMA	
remoteState	TokenNameIdentifier	 remote State
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
private	TokenNameprivate	
void	TokenNamevoid	
applyNewStates	TokenNameIdentifier	 apply New States
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
addr	TokenNameIdentifier	 addr
,	TokenNameCOMMA	
EndpointState	TokenNameIdentifier	 Endpoint State
localState	TokenNameIdentifier	 local State
,	TokenNameCOMMA	
EndpointState	TokenNameIdentifier	 Endpoint State
remoteState	TokenNameIdentifier	 remote State
)	TokenNameRPAREN	
{	TokenNameLBRACE	
// don't assert here, since if the node restarts the version will go back to zero 	TokenNameCOMMENT_LINE	don't assert here, since if the node restarts the version will go back to zero 
int	TokenNameint	
oldVersion	TokenNameIdentifier	 old Version
=	TokenNameEQUAL	
localState	TokenNameIdentifier	 local State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getHeartBeatVersion	TokenNameIdentifier	 get Heart Beat Version
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
localState	TokenNameIdentifier	 local State
.	TokenNameDOT	
setHeartBeatState	TokenNameIdentifier	 set Heart Beat State
(	TokenNameLPAREN	
remoteState	TokenNameIdentifier	 remote State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isTraceEnabled	TokenNameIdentifier	 is Trace Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
trace	TokenNameIdentifier	 trace
(	TokenNameLPAREN	
"Updating heartbeat state version to "	TokenNameStringLiteral	Updating heartbeat state version to 
+	TokenNamePLUS	
localState	TokenNameIdentifier	 local State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getHeartBeatVersion	TokenNameIdentifier	 get Heart Beat Version
(	TokenNameLPAREN	
)	TokenNameRPAREN	
+	TokenNamePLUS	
" from "	TokenNameStringLiteral	 from 
+	TokenNamePLUS	
oldVersion	TokenNameIdentifier	 old Version
+	TokenNamePLUS	
" for "	TokenNameStringLiteral	 for 
+	TokenNamePLUS	
addr	TokenNameIdentifier	 addr
+	TokenNamePLUS	
" ..."	TokenNameStringLiteral	 ...
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
// we need to make two loops here, one to apply, then another to notify, this way all states in an update are present and current when the notifications are received 	TokenNameCOMMENT_LINE	we need to make two loops here, one to apply, then another to notify, this way all states in an update are present and current when the notifications are received 
for	TokenNamefor	
(	TokenNameLPAREN	
Entry	TokenNameIdentifier	 Entry
<	TokenNameLESS	
ApplicationState	TokenNameIdentifier	 Application State
,	TokenNameCOMMA	
VersionedValue	TokenNameIdentifier	 Versioned Value
>	TokenNameGREATER	
remoteEntry	TokenNameIdentifier	 remote Entry
:	TokenNameCOLON	
remoteState	TokenNameIdentifier	 remote State
.	TokenNameDOT	
getApplicationStateMap	TokenNameIdentifier	 get Application State Map
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
entrySet	TokenNameIdentifier	 entry Set
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
ApplicationState	TokenNameIdentifier	 Application State
remoteKey	TokenNameIdentifier	 remote Key
=	TokenNameEQUAL	
remoteEntry	TokenNameIdentifier	 remote Entry
.	TokenNameDOT	
getKey	TokenNameIdentifier	 get Key
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
VersionedValue	TokenNameIdentifier	 Versioned Value
remoteValue	TokenNameIdentifier	 remote Value
=	TokenNameEQUAL	
remoteEntry	TokenNameIdentifier	 remote Entry
.	TokenNameDOT	
getValue	TokenNameIdentifier	 get Value
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
assert	TokenNameassert	
remoteState	TokenNameIdentifier	 remote State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getGeneration	TokenNameIdentifier	 get Generation
(	TokenNameLPAREN	
)	TokenNameRPAREN	
==	TokenNameEQUAL_EQUAL	
localState	TokenNameIdentifier	 local State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getGeneration	TokenNameIdentifier	 get Generation
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
localState	TokenNameIdentifier	 local State
.	TokenNameDOT	
addApplicationState	TokenNameIdentifier	 add Application State
(	TokenNameLPAREN	
remoteKey	TokenNameIdentifier	 remote Key
,	TokenNameCOMMA	
remoteValue	TokenNameIdentifier	 remote Value
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
for	TokenNamefor	
(	TokenNameLPAREN	
Entry	TokenNameIdentifier	 Entry
<	TokenNameLESS	
ApplicationState	TokenNameIdentifier	 Application State
,	TokenNameCOMMA	
VersionedValue	TokenNameIdentifier	 Versioned Value
>	TokenNameGREATER	
remoteEntry	TokenNameIdentifier	 remote Entry
:	TokenNameCOLON	
remoteState	TokenNameIdentifier	 remote State
.	TokenNameDOT	
getApplicationStateMap	TokenNameIdentifier	 get Application State Map
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
entrySet	TokenNameIdentifier	 entry Set
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
doNotifications	TokenNameIdentifier	 do Notifications
(	TokenNameLPAREN	
addr	TokenNameIdentifier	 addr
,	TokenNameCOMMA	
remoteEntry	TokenNameIdentifier	 remote Entry
.	TokenNameDOT	
getKey	TokenNameIdentifier	 get Key
(	TokenNameLPAREN	
)	TokenNameRPAREN	
,	TokenNameCOMMA	
remoteEntry	TokenNameIdentifier	 remote Entry
.	TokenNameDOT	
getValue	TokenNameIdentifier	 get Value
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
// notify that an application state has changed 	TokenNameCOMMENT_LINE	notify that an application state has changed 
private	TokenNameprivate	
void	TokenNamevoid	
doNotifications	TokenNameIdentifier	 do Notifications
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
addr	TokenNameIdentifier	 addr
,	TokenNameCOMMA	
ApplicationState	TokenNameIdentifier	 Application State
state	TokenNameIdentifier	 state
,	TokenNameCOMMA	
VersionedValue	TokenNameIdentifier	 Versioned Value
value	TokenNameIdentifier	 value
)	TokenNameRPAREN	
{	TokenNameLBRACE	
for	TokenNamefor	
(	TokenNameLPAREN	
IEndpointStateChangeSubscriber	TokenNameIdentifier	 I Endpoint State Change Subscriber
subscriber	TokenNameIdentifier	 subscriber
:	TokenNameCOLON	
subscribers	TokenNameIdentifier	 subscribers
)	TokenNameRPAREN	
{	TokenNameLBRACE	
subscriber	TokenNameIdentifier	 subscriber
.	TokenNameDOT	
onChange	TokenNameIdentifier	 on Change
(	TokenNameLPAREN	
addr	TokenNameIdentifier	 addr
,	TokenNameCOMMA	
state	TokenNameIdentifier	 state
,	TokenNameCOMMA	
value	TokenNameIdentifier	 value
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
/* Request all the state for the endpoint in the gDigest */	TokenNameCOMMENT_BLOCK	 Request all the state for the endpoint in the gDigest 
private	TokenNameprivate	
void	TokenNamevoid	
requestAll	TokenNameIdentifier	 request All
(	TokenNameLPAREN	
GossipDigest	TokenNameIdentifier	 Gossip Digest
gDigest	TokenNameIdentifier	 g Digest
,	TokenNameCOMMA	
List	TokenNameIdentifier	 List
<	TokenNameLESS	
GossipDigest	TokenNameIdentifier	 Gossip Digest
>	TokenNameGREATER	
deltaGossipDigestList	TokenNameIdentifier	 delta Gossip Digest List
,	TokenNameCOMMA	
int	TokenNameint	
remoteGeneration	TokenNameIdentifier	 remote Generation
)	TokenNameRPAREN	
{	TokenNameLBRACE	
/* We are here since we have no data for this endpoint locally so request everthing. */	TokenNameCOMMENT_BLOCK	 We are here since we have no data for this endpoint locally so request everthing. 
deltaGossipDigestList	TokenNameIdentifier	 delta Gossip Digest List
.	TokenNameDOT	
add	TokenNameIdentifier	 add
(	TokenNameLPAREN	
new	TokenNamenew	
GossipDigest	TokenNameIdentifier	 Gossip Digest
(	TokenNameLPAREN	
gDigest	TokenNameIdentifier	 g Digest
.	TokenNameDOT	
getEndpoint	TokenNameIdentifier	 get Endpoint
(	TokenNameLPAREN	
)	TokenNameRPAREN	
,	TokenNameCOMMA	
remoteGeneration	TokenNameIdentifier	 remote Generation
,	TokenNameCOMMA	
0	TokenNameIntegerLiteral	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isTraceEnabled	TokenNameIdentifier	 is Trace Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
trace	TokenNameIdentifier	 trace
(	TokenNameLPAREN	
"requestAll for "	TokenNameStringLiteral	requestAll for 
+	TokenNamePLUS	
gDigest	TokenNameIdentifier	 g Digest
.	TokenNameDOT	
getEndpoint	TokenNameIdentifier	 get Endpoint
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
/* Send all the data with version greater than maxRemoteVersion */	TokenNameCOMMENT_BLOCK	 Send all the data with version greater than maxRemoteVersion 
private	TokenNameprivate	
void	TokenNamevoid	
sendAll	TokenNameIdentifier	 send All
(	TokenNameLPAREN	
GossipDigest	TokenNameIdentifier	 Gossip Digest
gDigest	TokenNameIdentifier	 g Digest
,	TokenNameCOMMA	
Map	TokenNameIdentifier	 Map
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
,	TokenNameCOMMA	
EndpointState	TokenNameIdentifier	 Endpoint State
>	TokenNameGREATER	
deltaEpStateMap	TokenNameIdentifier	 delta Ep State Map
,	TokenNameCOMMA	
int	TokenNameint	
maxRemoteVersion	TokenNameIdentifier	 max Remote Version
)	TokenNameRPAREN	
{	TokenNameLBRACE	
EndpointState	TokenNameIdentifier	 Endpoint State
localEpStatePtr	TokenNameIdentifier	 local Ep State Ptr
=	TokenNameEQUAL	
getStateForVersionBiggerThan	TokenNameIdentifier	 get State For Version Bigger Than
(	TokenNameLPAREN	
gDigest	TokenNameIdentifier	 g Digest
.	TokenNameDOT	
getEndpoint	TokenNameIdentifier	 get Endpoint
(	TokenNameLPAREN	
)	TokenNameRPAREN	
,	TokenNameCOMMA	
maxRemoteVersion	TokenNameIdentifier	 max Remote Version
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
localEpStatePtr	TokenNameIdentifier	 local Ep State Ptr
!=	TokenNameNOT_EQUAL	
null	TokenNamenull	
)	TokenNameRPAREN	
deltaEpStateMap	TokenNameIdentifier	 delta Ep State Map
.	TokenNameDOT	
put	TokenNameIdentifier	 put
(	TokenNameLPAREN	
gDigest	TokenNameIdentifier	 g Digest
.	TokenNameDOT	
getEndpoint	TokenNameIdentifier	 get Endpoint
(	TokenNameLPAREN	
)	TokenNameRPAREN	
,	TokenNameCOMMA	
localEpStatePtr	TokenNameIdentifier	 local Ep State Ptr
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
/* This method is used to figure the state that the Gossiper has but Gossipee doesn't. The delta digests and the delta state are built up. */	TokenNameCOMMENT_BLOCK	 This method is used to figure the state that the Gossiper has but Gossipee doesn't. The delta digests and the delta state are built up. 
void	TokenNamevoid	
examineGossiper	TokenNameIdentifier	 examine Gossiper
(	TokenNameLPAREN	
List	TokenNameIdentifier	 List
<	TokenNameLESS	
GossipDigest	TokenNameIdentifier	 Gossip Digest
>	TokenNameGREATER	
gDigestList	TokenNameIdentifier	 g Digest List
,	TokenNameCOMMA	
List	TokenNameIdentifier	 List
<	TokenNameLESS	
GossipDigest	TokenNameIdentifier	 Gossip Digest
>	TokenNameGREATER	
deltaGossipDigestList	TokenNameIdentifier	 delta Gossip Digest List
,	TokenNameCOMMA	
Map	TokenNameIdentifier	 Map
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
,	TokenNameCOMMA	
EndpointState	TokenNameIdentifier	 Endpoint State
>	TokenNameGREATER	
deltaEpStateMap	TokenNameIdentifier	 delta Ep State Map
)	TokenNameRPAREN	
{	TokenNameLBRACE	
for	TokenNamefor	
(	TokenNameLPAREN	
GossipDigest	TokenNameIdentifier	 Gossip Digest
gDigest	TokenNameIdentifier	 g Digest
:	TokenNameCOLON	
gDigestList	TokenNameIdentifier	 g Digest List
)	TokenNameRPAREN	
{	TokenNameLBRACE	
int	TokenNameint	
remoteGeneration	TokenNameIdentifier	 remote Generation
=	TokenNameEQUAL	
gDigest	TokenNameIdentifier	 g Digest
.	TokenNameDOT	
getGeneration	TokenNameIdentifier	 get Generation
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
int	TokenNameint	
maxRemoteVersion	TokenNameIdentifier	 max Remote Version
=	TokenNameEQUAL	
gDigest	TokenNameIdentifier	 g Digest
.	TokenNameDOT	
getMaxVersion	TokenNameIdentifier	 get Max Version
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
/* Get state associated with the end point in digest */	TokenNameCOMMENT_BLOCK	 Get state associated with the end point in digest 
EndpointState	TokenNameIdentifier	 Endpoint State
epStatePtr	TokenNameIdentifier	 ep State Ptr
=	TokenNameEQUAL	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
gDigest	TokenNameIdentifier	 g Digest
.	TokenNameDOT	
getEndpoint	TokenNameIdentifier	 get Endpoint
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
/* Here we need to fire a GossipDigestAckMessage. If we have some data associated with this endpoint locally then we follow the "if" path of the logic. If we have absolutely nothing for this endpoint we need to request all the data for this endpoint. */	TokenNameCOMMENT_BLOCK	 Here we need to fire a GossipDigestAckMessage. If we have some data associated with this endpoint locally then we follow the "if" path of the logic. If we have absolutely nothing for this endpoint we need to request all the data for this endpoint. 
if	TokenNameif	
(	TokenNameLPAREN	
epStatePtr	TokenNameIdentifier	 ep State Ptr
!=	TokenNameNOT_EQUAL	
null	TokenNamenull	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
int	TokenNameint	
localGeneration	TokenNameIdentifier	 local Generation
=	TokenNameEQUAL	
epStatePtr	TokenNameIdentifier	 ep State Ptr
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getGeneration	TokenNameIdentifier	 get Generation
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
/* get the max version of all keys in the state associated with this endpoint */	TokenNameCOMMENT_BLOCK	 get the max version of all keys in the state associated with this endpoint 
int	TokenNameint	
maxLocalVersion	TokenNameIdentifier	 max Local Version
=	TokenNameEQUAL	
getMaxEndpointStateVersion	TokenNameIdentifier	 get Max Endpoint State Version
(	TokenNameLPAREN	
epStatePtr	TokenNameIdentifier	 ep State Ptr
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
remoteGeneration	TokenNameIdentifier	 remote Generation
==	TokenNameEQUAL_EQUAL	
localGeneration	TokenNameIdentifier	 local Generation
&&	TokenNameAND_AND	
maxRemoteVersion	TokenNameIdentifier	 max Remote Version
==	TokenNameEQUAL_EQUAL	
maxLocalVersion	TokenNameIdentifier	 max Local Version
)	TokenNameRPAREN	
continue	TokenNamecontinue	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
remoteGeneration	TokenNameIdentifier	 remote Generation
>	TokenNameGREATER	
localGeneration	TokenNameIdentifier	 local Generation
)	TokenNameRPAREN	
{	TokenNameLBRACE	
/* we request everything from the gossiper */	TokenNameCOMMENT_BLOCK	 we request everything from the gossiper 
requestAll	TokenNameIdentifier	 request All
(	TokenNameLPAREN	
gDigest	TokenNameIdentifier	 g Digest
,	TokenNameCOMMA	
deltaGossipDigestList	TokenNameIdentifier	 delta Gossip Digest List
,	TokenNameCOMMA	
remoteGeneration	TokenNameIdentifier	 remote Generation
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
else	TokenNameelse	
if	TokenNameif	
(	TokenNameLPAREN	
remoteGeneration	TokenNameIdentifier	 remote Generation
<	TokenNameLESS	
localGeneration	TokenNameIdentifier	 local Generation
)	TokenNameRPAREN	
{	TokenNameLBRACE	
/* send all data with generation = localgeneration and version > 0 */	TokenNameCOMMENT_BLOCK	 send all data with generation = localgeneration and version > 0 
sendAll	TokenNameIdentifier	 send All
(	TokenNameLPAREN	
gDigest	TokenNameIdentifier	 g Digest
,	TokenNameCOMMA	
deltaEpStateMap	TokenNameIdentifier	 delta Ep State Map
,	TokenNameCOMMA	
0	TokenNameIntegerLiteral	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
else	TokenNameelse	
if	TokenNameif	
(	TokenNameLPAREN	
remoteGeneration	TokenNameIdentifier	 remote Generation
==	TokenNameEQUAL_EQUAL	
localGeneration	TokenNameIdentifier	 local Generation
)	TokenNameRPAREN	
{	TokenNameLBRACE	
/* If the max remote version is greater then we request the remote endpoint send us all the data for this endpoint with version greater than the max version number we have locally for this endpoint. If the max remote version is lesser, then we send all the data we have locally for this endpoint with version greater than the max remote version. */	TokenNameCOMMENT_BLOCK	 If the max remote version is greater then we request the remote endpoint send us all the data for this endpoint with version greater than the max version number we have locally for this endpoint. If the max remote version is lesser, then we send all the data we have locally for this endpoint with version greater than the max remote version. 
if	TokenNameif	
(	TokenNameLPAREN	
maxRemoteVersion	TokenNameIdentifier	 max Remote Version
>	TokenNameGREATER	
maxLocalVersion	TokenNameIdentifier	 max Local Version
)	TokenNameRPAREN	
{	TokenNameLBRACE	
deltaGossipDigestList	TokenNameIdentifier	 delta Gossip Digest List
.	TokenNameDOT	
add	TokenNameIdentifier	 add
(	TokenNameLPAREN	
new	TokenNamenew	
GossipDigest	TokenNameIdentifier	 Gossip Digest
(	TokenNameLPAREN	
gDigest	TokenNameIdentifier	 g Digest
.	TokenNameDOT	
getEndpoint	TokenNameIdentifier	 get Endpoint
(	TokenNameLPAREN	
)	TokenNameRPAREN	
,	TokenNameCOMMA	
remoteGeneration	TokenNameIdentifier	 remote Generation
,	TokenNameCOMMA	
maxLocalVersion	TokenNameIdentifier	 max Local Version
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
else	TokenNameelse	
if	TokenNameif	
(	TokenNameLPAREN	
maxRemoteVersion	TokenNameIdentifier	 max Remote Version
<	TokenNameLESS	
maxLocalVersion	TokenNameIdentifier	 max Local Version
)	TokenNameRPAREN	
{	TokenNameLBRACE	
/* send all data with generation = localgeneration and version > maxRemoteVersion */	TokenNameCOMMENT_BLOCK	 send all data with generation = localgeneration and version > maxRemoteVersion 
sendAll	TokenNameIdentifier	 send All
(	TokenNameLPAREN	
gDigest	TokenNameIdentifier	 g Digest
,	TokenNameCOMMA	
deltaEpStateMap	TokenNameIdentifier	 delta Ep State Map
,	TokenNameCOMMA	
maxRemoteVersion	TokenNameIdentifier	 max Remote Version
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
else	TokenNameelse	
{	TokenNameLBRACE	
/* We are here since we have no data for this endpoint locally so request everything. */	TokenNameCOMMENT_BLOCK	 We are here since we have no data for this endpoint locally so request everything. 
requestAll	TokenNameIdentifier	 request All
(	TokenNameLPAREN	
gDigest	TokenNameIdentifier	 g Digest
,	TokenNameCOMMA	
deltaGossipDigestList	TokenNameIdentifier	 delta Gossip Digest List
,	TokenNameCOMMA	
remoteGeneration	TokenNameIdentifier	 remote Generation
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
/** * Start the gossiper with the generation # retrieved from the System * table */	TokenNameCOMMENT_JAVADOC	 Start the gossiper with the generation # retrieved from the System table 
public	TokenNamepublic	
void	TokenNamevoid	
start	TokenNameIdentifier	 start
(	TokenNameLPAREN	
int	TokenNameint	
generationNbr	TokenNameIdentifier	 generation Nbr
)	TokenNameRPAREN	
{	TokenNameLBRACE	
/* Get the seeds from the config and initialize them. */	TokenNameCOMMENT_BLOCK	 Get the seeds from the config and initialize them. 
Set	TokenNameIdentifier	 Set
<	TokenNameLESS	
InetAddress	TokenNameIdentifier	 Inet Address
>	TokenNameGREATER	
seedHosts	TokenNameIdentifier	 seed Hosts
=	TokenNameEQUAL	
DatabaseDescriptor	TokenNameIdentifier	 Database Descriptor
.	TokenNameDOT	
getSeeds	TokenNameIdentifier	 get Seeds
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
for	TokenNamefor	
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
seed	TokenNameIdentifier	 seed
:	TokenNameCOLON	
seedHosts	TokenNameIdentifier	 seed Hosts
)	TokenNameRPAREN	
{	TokenNameLBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
seed	TokenNameIdentifier	 seed
.	TokenNameDOT	
equals	TokenNameIdentifier	 equals
(	TokenNameLPAREN	
FBUtilities	TokenNameIdentifier	 FB Utilities
.	TokenNameDOT	
getBroadcastAddress	TokenNameIdentifier	 get Broadcast Address
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
continue	TokenNamecontinue	
;	TokenNameSEMICOLON	
seeds	TokenNameIdentifier	 seeds
.	TokenNameDOT	
add	TokenNameIdentifier	 add
(	TokenNameLPAREN	
seed	TokenNameIdentifier	 seed
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
/* initialize the heartbeat state for this localEndpoint */	TokenNameCOMMENT_BLOCK	 initialize the heartbeat state for this localEndpoint 
maybeInitializeLocalState	TokenNameIdentifier	 maybe Initialize Local State
(	TokenNameLPAREN	
generationNbr	TokenNameIdentifier	 generation Nbr
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
EndpointState	TokenNameIdentifier	 Endpoint State
localState	TokenNameIdentifier	 local State
=	TokenNameEQUAL	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
FBUtilities	TokenNameIdentifier	 FB Utilities
.	TokenNameDOT	
getBroadcastAddress	TokenNameIdentifier	 get Broadcast Address
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
//notify snitches that Gossiper is about to start 	TokenNameCOMMENT_LINE	notify snitches that Gossiper is about to start 
DatabaseDescriptor	TokenNameIdentifier	 Database Descriptor
.	TokenNameDOT	
getEndpointSnitch	TokenNameIdentifier	 get Endpoint Snitch
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
gossiperStarting	TokenNameIdentifier	 gossiper Starting
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isTraceEnabled	TokenNameIdentifier	 is Trace Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
trace	TokenNameIdentifier	 trace
(	TokenNameLPAREN	
"gossip started with generation "	TokenNameStringLiteral	gossip started with generation 
+	TokenNamePLUS	
localState	TokenNameIdentifier	 local State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getGeneration	TokenNameIdentifier	 get Generation
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
scheduledGossipTask	TokenNameIdentifier	 scheduled Gossip Task
=	TokenNameEQUAL	
executor	TokenNameIdentifier	 executor
.	TokenNameDOT	
scheduleWithFixedDelay	TokenNameIdentifier	 schedule With Fixed Delay
(	TokenNameLPAREN	
new	TokenNamenew	
GossipTask	TokenNameIdentifier	 Gossip Task
(	TokenNameLPAREN	
)	TokenNameRPAREN	
,	TokenNameCOMMA	
Gossiper	TokenNameIdentifier	 Gossiper
.	TokenNameDOT	
intervalInMillis	TokenNameIdentifier	 interval In Millis
,	TokenNameCOMMA	
Gossiper	TokenNameIdentifier	 Gossiper
.	TokenNameDOT	
intervalInMillis	TokenNameIdentifier	 interval In Millis
,	TokenNameCOMMA	
TimeUnit	TokenNameIdentifier	 Time Unit
.	TokenNameDOT	
MILLISECONDS	TokenNameIdentifier	 MILLISECONDS
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
// initialize local HB state if needed, i.e., if gossiper has never been started before. 	TokenNameCOMMENT_LINE	initialize local HB state if needed, i.e., if gossiper has never been started before. 
public	TokenNamepublic	
void	TokenNamevoid	
maybeInitializeLocalState	TokenNameIdentifier	 maybe Initialize Local State
(	TokenNameLPAREN	
int	TokenNameint	
generationNbr	TokenNameIdentifier	 generation Nbr
)	TokenNameRPAREN	
{	TokenNameLBRACE	
HeartBeatState	TokenNameIdentifier	 Heart Beat State
hbState	TokenNameIdentifier	 hb State
=	TokenNameEQUAL	
new	TokenNamenew	
HeartBeatState	TokenNameIdentifier	 Heart Beat State
(	TokenNameLPAREN	
generationNbr	TokenNameIdentifier	 generation Nbr
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
EndpointState	TokenNameIdentifier	 Endpoint State
localState	TokenNameIdentifier	 local State
=	TokenNameEQUAL	
new	TokenNamenew	
EndpointState	TokenNameIdentifier	 Endpoint State
(	TokenNameLPAREN	
hbState	TokenNameIdentifier	 hb State
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
localState	TokenNameIdentifier	 local State
.	TokenNameDOT	
markAlive	TokenNameIdentifier	 mark Alive
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
putIfAbsent	TokenNameIdentifier	 put If Absent
(	TokenNameLPAREN	
FBUtilities	TokenNameIdentifier	 FB Utilities
.	TokenNameDOT	
getBroadcastAddress	TokenNameIdentifier	 get Broadcast Address
(	TokenNameLPAREN	
)	TokenNameRPAREN	
,	TokenNameCOMMA	
localState	TokenNameIdentifier	 local State
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
/** * Add an endpoint we knew about previously, but whose state is unknown */	TokenNameCOMMENT_JAVADOC	 Add an endpoint we knew about previously, but whose state is unknown 
public	TokenNamepublic	
void	TokenNamevoid	
addSavedEndpoint	TokenNameIdentifier	 add Saved Endpoint
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
ep	TokenNameIdentifier	 ep
)	TokenNameRPAREN	
{	TokenNameLBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
ep	TokenNameIdentifier	 ep
.	TokenNameDOT	
equals	TokenNameIdentifier	 equals
(	TokenNameLPAREN	
FBUtilities	TokenNameIdentifier	 FB Utilities
.	TokenNameDOT	
getBroadcastAddress	TokenNameIdentifier	 get Broadcast Address
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
debug	TokenNameIdentifier	 debug
(	TokenNameLPAREN	
"Attempt to add self as saved endpoint"	TokenNameStringLiteral	Attempt to add self as saved endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
return	TokenNamereturn	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
EndpointState	TokenNameIdentifier	 Endpoint State
epState	TokenNameIdentifier	 ep State
=	TokenNameEQUAL	
new	TokenNamenew	
EndpointState	TokenNameIdentifier	 Endpoint State
(	TokenNameLPAREN	
new	TokenNamenew	
HeartBeatState	TokenNameIdentifier	 Heart Beat State
(	TokenNameLPAREN	
0	TokenNameIntegerLiteral	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
markDead	TokenNameIdentifier	 mark Dead
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
put	TokenNameIdentifier	 put
(	TokenNameLPAREN	
ep	TokenNameIdentifier	 ep
,	TokenNameCOMMA	
epState	TokenNameIdentifier	 ep State
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
unreachableEndpoints	TokenNameIdentifier	 unreachable Endpoints
.	TokenNameDOT	
put	TokenNameIdentifier	 put
(	TokenNameLPAREN	
ep	TokenNameIdentifier	 ep
,	TokenNameCOMMA	
System	TokenNameIdentifier	 System
.	TokenNameDOT	
currentTimeMillis	TokenNameIdentifier	 current Time Millis
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isTraceEnabled	TokenNameIdentifier	 is Trace Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
trace	TokenNameIdentifier	 trace
(	TokenNameLPAREN	
"Adding saved endpoint "	TokenNameStringLiteral	Adding saved endpoint 
+	TokenNamePLUS	
ep	TokenNameIdentifier	 ep
+	TokenNamePLUS	
" "	TokenNameStringLiteral	 
+	TokenNamePLUS	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
getHeartBeatState	TokenNameIdentifier	 get Heart Beat State
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getGeneration	TokenNameIdentifier	 get Generation
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
public	TokenNamepublic	
void	TokenNamevoid	
addLocalApplicationState	TokenNameIdentifier	 add Local Application State
(	TokenNameLPAREN	
ApplicationState	TokenNameIdentifier	 Application State
state	TokenNameIdentifier	 state
,	TokenNameCOMMA	
VersionedValue	TokenNameIdentifier	 Versioned Value
value	TokenNameIdentifier	 value
)	TokenNameRPAREN	
{	TokenNameLBRACE	
EndpointState	TokenNameIdentifier	 Endpoint State
epState	TokenNameIdentifier	 ep State
=	TokenNameEQUAL	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
FBUtilities	TokenNameIdentifier	 FB Utilities
.	TokenNameDOT	
getBroadcastAddress	TokenNameIdentifier	 get Broadcast Address
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
assert	TokenNameassert	
epState	TokenNameIdentifier	 ep State
!=	TokenNameNOT_EQUAL	
null	TokenNamenull	
;	TokenNameSEMICOLON	
epState	TokenNameIdentifier	 ep State
.	TokenNameDOT	
addApplicationState	TokenNameIdentifier	 add Application State
(	TokenNameLPAREN	
state	TokenNameIdentifier	 state
,	TokenNameCOMMA	
value	TokenNameIdentifier	 value
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
doNotifications	TokenNameIdentifier	 do Notifications
(	TokenNameLPAREN	
FBUtilities	TokenNameIdentifier	 FB Utilities
.	TokenNameDOT	
getBroadcastAddress	TokenNameIdentifier	 get Broadcast Address
(	TokenNameLPAREN	
)	TokenNameRPAREN	
,	TokenNameCOMMA	
state	TokenNameIdentifier	 state
,	TokenNameCOMMA	
value	TokenNameIdentifier	 value
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
public	TokenNamepublic	
void	TokenNamevoid	
stop	TokenNameIdentifier	 stop
(	TokenNameLPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
scheduledGossipTask	TokenNameIdentifier	 scheduled Gossip Task
.	TokenNameDOT	
cancel	TokenNameIdentifier	 cancel
(	TokenNameLPAREN	
false	TokenNamefalse	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
info	TokenNameIdentifier	 info
(	TokenNameLPAREN	
"Announcing shutdown"	TokenNameStringLiteral	Announcing shutdown
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
try	TokenNametry	
{	TokenNameLBRACE	
Thread	TokenNameIdentifier	 Thread
.	TokenNameDOT	
sleep	TokenNameIdentifier	 sleep
(	TokenNameLPAREN	
intervalInMillis	TokenNameIdentifier	 interval In Millis
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
catch	TokenNamecatch	
(	TokenNameLPAREN	
InterruptedException	TokenNameIdentifier	 Interrupted Exception
e	TokenNameIdentifier	 e
)	TokenNameRPAREN	
{	TokenNameLBRACE	
throw	TokenNamethrow	
new	TokenNamenew	
RuntimeException	TokenNameIdentifier	 Runtime Exception
(	TokenNameLPAREN	
e	TokenNameIdentifier	 e
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
MessageOut	TokenNameIdentifier	 Message Out
message	TokenNameIdentifier	 message
=	TokenNameEQUAL	
new	TokenNamenew	
MessageOut	TokenNameIdentifier	 Message Out
(	TokenNameLPAREN	
MessagingService	TokenNameIdentifier	 Messaging Service
.	TokenNameDOT	
Verb	TokenNameIdentifier	 Verb
.	TokenNameDOT	
GOSSIP_SHUTDOWN	TokenNameIdentifier	 GOSSIP  SHUTDOWN
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
for	TokenNamefor	
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
ep	TokenNameIdentifier	 ep
:	TokenNameCOLON	
liveEndpoints	TokenNameIdentifier	 live Endpoints
)	TokenNameRPAREN	
MessagingService	TokenNameIdentifier	 Messaging Service
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
sendOneWay	TokenNameIdentifier	 send One Way
(	TokenNameLPAREN	
message	TokenNameIdentifier	 message
,	TokenNameCOMMA	
ep	TokenNameIdentifier	 ep
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
public	TokenNamepublic	
boolean	TokenNameboolean	
isEnabled	TokenNameIdentifier	 is Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
return	TokenNamereturn	
(	TokenNameLPAREN	
scheduledGossipTask	TokenNameIdentifier	 scheduled Gossip Task
!=	TokenNameNOT_EQUAL	
null	TokenNamenull	
)	TokenNameRPAREN	
&&	TokenNameAND_AND	
(	TokenNameLPAREN	
!	TokenNameNOT	
scheduledGossipTask	TokenNameIdentifier	 scheduled Gossip Task
.	TokenNameDOT	
isCancelled	TokenNameIdentifier	 is Cancelled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
@	TokenNameAT	
VisibleForTesting	TokenNameIdentifier	 Visible For Testing
public	TokenNamepublic	
void	TokenNamevoid	
initializeNodeUnsafe	TokenNameIdentifier	 initialize Node Unsafe
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
addr	TokenNameIdentifier	 addr
,	TokenNameCOMMA	
UUID	TokenNameIdentifier	 UUID
uuid	TokenNameIdentifier	 uuid
,	TokenNameCOMMA	
int	TokenNameint	
generationNbr	TokenNameIdentifier	 generation Nbr
)	TokenNameRPAREN	
{	TokenNameLBRACE	
HeartBeatState	TokenNameIdentifier	 Heart Beat State
hbState	TokenNameIdentifier	 hb State
=	TokenNameEQUAL	
new	TokenNamenew	
HeartBeatState	TokenNameIdentifier	 Heart Beat State
(	TokenNameLPAREN	
generationNbr	TokenNameIdentifier	 generation Nbr
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
EndpointState	TokenNameIdentifier	 Endpoint State
newState	TokenNameIdentifier	 new State
=	TokenNameEQUAL	
new	TokenNamenew	
EndpointState	TokenNameIdentifier	 Endpoint State
(	TokenNameLPAREN	
hbState	TokenNameIdentifier	 hb State
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
newState	TokenNameIdentifier	 new State
.	TokenNameDOT	
markAlive	TokenNameIdentifier	 mark Alive
(	TokenNameLPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
EndpointState	TokenNameIdentifier	 Endpoint State
oldState	TokenNameIdentifier	 old State
=	TokenNameEQUAL	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
putIfAbsent	TokenNameIdentifier	 put If Absent
(	TokenNameLPAREN	
addr	TokenNameIdentifier	 addr
,	TokenNameCOMMA	
newState	TokenNameIdentifier	 new State
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
EndpointState	TokenNameIdentifier	 Endpoint State
localState	TokenNameIdentifier	 local State
=	TokenNameEQUAL	
oldState	TokenNameIdentifier	 old State
==	TokenNameEQUAL_EQUAL	
null	TokenNamenull	
?	TokenNameQUESTION	
newState	TokenNameIdentifier	 new State
:	TokenNameCOLON	
oldState	TokenNameIdentifier	 old State
;	TokenNameSEMICOLON	
// always add the version state 	TokenNameCOMMENT_LINE	always add the version state 
localState	TokenNameIdentifier	 local State
.	TokenNameDOT	
addApplicationState	TokenNameIdentifier	 add Application State
(	TokenNameLPAREN	
ApplicationState	TokenNameIdentifier	 Application State
.	TokenNameDOT	
NET_VERSION	TokenNameIdentifier	 NET  VERSION
,	TokenNameCOMMA	
StorageService	TokenNameIdentifier	 Storage Service
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
.	TokenNameDOT	
valueFactory	TokenNameIdentifier	 value Factory
.	TokenNameDOT	
networkVersion	TokenNameIdentifier	 network Version
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
localState	TokenNameIdentifier	 local State
.	TokenNameDOT	
addApplicationState	TokenNameIdentifier	 add Application State
(	TokenNameLPAREN	
ApplicationState	TokenNameIdentifier	 Application State
.	TokenNameDOT	
HOST_ID	TokenNameIdentifier	 HOST  ID
,	TokenNameCOMMA	
StorageService	TokenNameIdentifier	 Storage Service
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
.	TokenNameDOT	
valueFactory	TokenNameIdentifier	 value Factory
.	TokenNameDOT	
hostId	TokenNameIdentifier	 host Id
(	TokenNameLPAREN	
uuid	TokenNameIdentifier	 uuid
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
@	TokenNameAT	
VisibleForTesting	TokenNameIdentifier	 Visible For Testing
public	TokenNamepublic	
void	TokenNamevoid	
injectApplicationState	TokenNameIdentifier	 inject Application State
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
endpoint	TokenNameIdentifier	 endpoint
,	TokenNameCOMMA	
ApplicationState	TokenNameIdentifier	 Application State
state	TokenNameIdentifier	 state
,	TokenNameCOMMA	
VersionedValue	TokenNameIdentifier	 Versioned Value
value	TokenNameIdentifier	 value
)	TokenNameRPAREN	
{	TokenNameLBRACE	
EndpointState	TokenNameIdentifier	 Endpoint State
localState	TokenNameIdentifier	 local State
=	TokenNameEQUAL	
endpointStateMap	TokenNameIdentifier	 endpoint State Map
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
localState	TokenNameIdentifier	 local State
.	TokenNameDOT	
addApplicationState	TokenNameIdentifier	 add Application State
(	TokenNameLPAREN	
state	TokenNameIdentifier	 state
,	TokenNameCOMMA	
value	TokenNameIdentifier	 value
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
public	TokenNamepublic	
long	TokenNamelong	
getEndpointDowntime	TokenNameIdentifier	 get Endpoint Downtime
(	TokenNameLPAREN	
String	TokenNameIdentifier	 String
address	TokenNameIdentifier	 address
)	TokenNameRPAREN	
throws	TokenNamethrows	
UnknownHostException	TokenNameIdentifier	 Unknown Host Exception
{	TokenNameLBRACE	
return	TokenNamereturn	
getEndpointDowntime	TokenNameIdentifier	 get Endpoint Downtime
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
.	TokenNameDOT	
getByName	TokenNameIdentifier	 get By Name
(	TokenNameLPAREN	
address	TokenNameIdentifier	 address
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
public	TokenNamepublic	
int	TokenNameint	
getCurrentGenerationNumber	TokenNameIdentifier	 get Current Generation Number
(	TokenNameLPAREN	
String	TokenNameIdentifier	 String
address	TokenNameIdentifier	 address
)	TokenNameRPAREN	
throws	TokenNamethrows	
UnknownHostException	TokenNameIdentifier	 Unknown Host Exception
{	TokenNameLBRACE	
return	TokenNamereturn	
getCurrentGenerationNumber	TokenNameIdentifier	 get Current Generation Number
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
.	TokenNameDOT	
getByName	TokenNameIdentifier	 get By Name
(	TokenNameLPAREN	
address	TokenNameIdentifier	 address
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
public	TokenNamepublic	
void	TokenNamevoid	
addExpireTimeForEndpoint	TokenNameIdentifier	 add Expire Time For Endpoint
(	TokenNameLPAREN	
InetAddress	TokenNameIdentifier	 Inet Address
endpoint	TokenNameIdentifier	 endpoint
,	TokenNameCOMMA	
long	TokenNamelong	
expireTime	TokenNameIdentifier	 expire Time
)	TokenNameRPAREN	
{	TokenNameLBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
isDebugEnabled	TokenNameIdentifier	 is Debug Enabled
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
debug	TokenNameIdentifier	 debug
(	TokenNameLPAREN	
"adding expire time for endpoint : "	TokenNameStringLiteral	adding expire time for endpoint : 
+	TokenNamePLUS	
endpoint	TokenNameIdentifier	 endpoint
+	TokenNamePLUS	
" ("	TokenNameStringLiteral	 (
+	TokenNamePLUS	
expireTime	TokenNameIdentifier	 expire Time
+	TokenNamePLUS	
")"	TokenNameStringLiteral	)
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
expireTimeEndpointMap	TokenNameIdentifier	 expire Time Endpoint Map
.	TokenNameDOT	
put	TokenNameIdentifier	 put
(	TokenNameLPAREN	
endpoint	TokenNameIdentifier	 endpoint
,	TokenNameCOMMA	
expireTime	TokenNameIdentifier	 expire Time
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
public	TokenNamepublic	
static	TokenNamestatic	
long	TokenNamelong	
computeExpireTime	TokenNameIdentifier	 compute Expire Time
(	TokenNameLPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
return	TokenNamereturn	
System	TokenNameIdentifier	 System
.	TokenNameDOT	
currentTimeMillis	TokenNameIdentifier	 current Time Millis
(	TokenNameLPAREN	
)	TokenNameRPAREN	
+	TokenNamePLUS	
Gossiper	TokenNameIdentifier	 Gossiper
.	TokenNameDOT	
aVeryLongTime	TokenNameIdentifier	 a Very Long Time
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
