/* * Licensed to the Apache Software Foundation (ASF) under one * or more contributor license agreements. See the NOTICE file * distributed with this work for additional information * regarding copyright ownership. The ASF licenses this file * to you under the Apache License, Version 2.0 (the * "License"); you may not use this file except in compliance * with the License. You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */	TokenNameCOMMENT_BLOCK	 Licensed to the Apache Software Foundation (ASF) under one or more contributor license agreements. See the NOTICE file distributed with this work for additional information regarding copyright ownership. The ASF licenses this file to you under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at * http://www.apache.org/licenses/LICENSE-2.0 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License. 
package	TokenNamepackage	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
apache	TokenNameIdentifier	 apache
.	TokenNameDOT	
cassandra	TokenNameIdentifier	 cassandra
.	TokenNameDOT	
db	TokenNameIdentifier	 db
.	TokenNameDOT	
compaction	TokenNameIdentifier	 compaction
;	TokenNameSEMICOLON	
import	TokenNameimport	
java	TokenNameIdentifier	 java
.	TokenNameDOT	
util	TokenNameIdentifier	 util
.	TokenNameDOT	
Collection	TokenNameIdentifier	 Collection
;	TokenNameSEMICOLON	
import	TokenNameimport	
java	TokenNameIdentifier	 java
.	TokenNameDOT	
util	TokenNameIdentifier	 util
.	TokenNameDOT	
Collections	TokenNameIdentifier	 Collections
;	TokenNameSEMICOLON	
import	TokenNameimport	
java	TokenNameIdentifier	 java
.	TokenNameDOT	
util	TokenNameIdentifier	 util
.	TokenNameDOT	
List	TokenNameIdentifier	 List
;	TokenNameSEMICOLON	
import	TokenNameimport	
java	TokenNameIdentifier	 java
.	TokenNameDOT	
util	TokenNameIdentifier	 util
.	TokenNameDOT	
Set	TokenNameIdentifier	 Set
;	TokenNameSEMICOLON	
import	TokenNameimport	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
slf4j	TokenNameIdentifier	 slf4j
.	TokenNameDOT	
Logger	TokenNameIdentifier	 Logger
;	TokenNameSEMICOLON	
import	TokenNameimport	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
slf4j	TokenNameIdentifier	 slf4j
.	TokenNameDOT	
LoggerFactory	TokenNameIdentifier	 Logger Factory
;	TokenNameSEMICOLON	
import	TokenNameimport	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
apache	TokenNameIdentifier	 apache
.	TokenNameDOT	
cassandra	TokenNameIdentifier	 cassandra
.	TokenNameDOT	
config	TokenNameIdentifier	 config
.	TokenNameDOT	
DatabaseDescriptor	TokenNameIdentifier	 Database Descriptor
;	TokenNameSEMICOLON	
import	TokenNameimport	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
apache	TokenNameIdentifier	 apache
.	TokenNameDOT	
cassandra	TokenNameIdentifier	 cassandra
.	TokenNameDOT	
db	TokenNameIdentifier	 db
.	TokenNameDOT	
ColumnFamily	TokenNameIdentifier	 Column Family
;	TokenNameSEMICOLON	
import	TokenNameimport	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
apache	TokenNameIdentifier	 apache
.	TokenNameDOT	
cassandra	TokenNameIdentifier	 cassandra
.	TokenNameDOT	
db	TokenNameIdentifier	 db
.	TokenNameDOT	
ColumnFamilyStore	TokenNameIdentifier	 Column Family Store
;	TokenNameSEMICOLON	
import	TokenNameimport	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
apache	TokenNameIdentifier	 apache
.	TokenNameDOT	
cassandra	TokenNameIdentifier	 cassandra
.	TokenNameDOT	
db	TokenNameIdentifier	 db
.	TokenNameDOT	
DataTracker	TokenNameIdentifier	 Data Tracker
;	TokenNameSEMICOLON	
import	TokenNameimport	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
apache	TokenNameIdentifier	 apache
.	TokenNameDOT	
cassandra	TokenNameIdentifier	 cassandra
.	TokenNameDOT	
db	TokenNameIdentifier	 db
.	TokenNameDOT	
DecoratedKey	TokenNameIdentifier	 Decorated Key
;	TokenNameSEMICOLON	
import	TokenNameimport	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
apache	TokenNameIdentifier	 apache
.	TokenNameDOT	
cassandra	TokenNameIdentifier	 cassandra
.	TokenNameDOT	
io	TokenNameIdentifier	 io
.	TokenNameDOT	
sstable	TokenNameIdentifier	 sstable
.	TokenNameDOT	
SSTableIdentityIterator	TokenNameIdentifier	 SS Table Identity Iterator
;	TokenNameSEMICOLON	
import	TokenNameimport	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
apache	TokenNameIdentifier	 apache
.	TokenNameDOT	
cassandra	TokenNameIdentifier	 cassandra
.	TokenNameDOT	
io	TokenNameIdentifier	 io
.	TokenNameDOT	
sstable	TokenNameIdentifier	 sstable
.	TokenNameDOT	
SSTableReader	TokenNameIdentifier	 SS Table Reader
;	TokenNameSEMICOLON	
import	TokenNameimport	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
apache	TokenNameIdentifier	 apache
.	TokenNameDOT	
cassandra	TokenNameIdentifier	 cassandra
.	TokenNameDOT	
service	TokenNameIdentifier	 service
.	TokenNameDOT	
CacheService	TokenNameIdentifier	 Cache Service
;	TokenNameSEMICOLON	
import	TokenNameimport	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
apache	TokenNameIdentifier	 apache
.	TokenNameDOT	
cassandra	TokenNameIdentifier	 cassandra
.	TokenNameDOT	
service	TokenNameIdentifier	 service
.	TokenNameDOT	
StorageService	TokenNameIdentifier	 Storage Service
;	TokenNameSEMICOLON	
import	TokenNameimport	
org	TokenNameIdentifier	 org
.	TokenNameDOT	
apache	TokenNameIdentifier	 apache
.	TokenNameDOT	
cassandra	TokenNameIdentifier	 cassandra
.	TokenNameDOT	
utils	TokenNameIdentifier	 utils
.	TokenNameDOT	
Throttle	TokenNameIdentifier	 Throttle
;	TokenNameSEMICOLON	
/** * Manage compaction options. */	TokenNameCOMMENT_JAVADOC	 Manage compaction options. 
public	TokenNamepublic	
class	TokenNameclass	
CompactionController	TokenNameIdentifier	 Compaction Controller
{	TokenNameLBRACE	
private	TokenNameprivate	
static	TokenNamestatic	
final	TokenNamefinal	
Logger	TokenNameIdentifier	 Logger
logger	TokenNameIdentifier	 logger
=	TokenNameEQUAL	
LoggerFactory	TokenNameIdentifier	 Logger Factory
.	TokenNameDOT	
getLogger	TokenNameIdentifier	 get Logger
(	TokenNameLPAREN	
CompactionController	TokenNameIdentifier	 Compaction Controller
.	TokenNameDOT	
class	TokenNameclass	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
public	TokenNamepublic	
final	TokenNamefinal	
ColumnFamilyStore	TokenNameIdentifier	 Column Family Store
cfs	TokenNameIdentifier	 cfs
;	TokenNameSEMICOLON	
private	TokenNameprivate	
final	TokenNamefinal	
DataTracker	TokenNameIdentifier	 Data Tracker
.	TokenNameDOT	
SSTableIntervalTree	TokenNameIdentifier	 SS Table Interval Tree
overlappingTree	TokenNameIdentifier	 overlapping Tree
;	TokenNameSEMICOLON	
private	TokenNameprivate	
final	TokenNamefinal	
Set	TokenNameIdentifier	 Set
<	TokenNameLESS	
SSTableReader	TokenNameIdentifier	 SS Table Reader
>	TokenNameGREATER	
overlappingSSTables	TokenNameIdentifier	 overlapping SS Tables
;	TokenNameSEMICOLON	
public	TokenNamepublic	
final	TokenNamefinal	
int	TokenNameint	
gcBefore	TokenNameIdentifier	 gc Before
;	TokenNameSEMICOLON	
public	TokenNamepublic	
final	TokenNamefinal	
int	TokenNameint	
mergeShardBefore	TokenNameIdentifier	 merge Shard Before
;	TokenNameSEMICOLON	
private	TokenNameprivate	
final	TokenNamefinal	
Throttle	TokenNameIdentifier	 Throttle
throttle	TokenNameIdentifier	 throttle
=	TokenNameEQUAL	
new	TokenNamenew	
Throttle	TokenNameIdentifier	 Throttle
(	TokenNameLPAREN	
"Cassandra_Throttle"	TokenNameStringLiteral	Cassandra_Throttle
,	TokenNameCOMMA	
new	TokenNamenew	
Throttle	TokenNameIdentifier	 Throttle
.	TokenNameDOT	
ThroughputFunction	TokenNameIdentifier	 Throughput Function
(	TokenNameLPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
/** @return Instantaneous throughput target in bytes per millisecond. */	TokenNameCOMMENT_JAVADOC	 @return Instantaneous throughput target in bytes per millisecond. 
public	TokenNamepublic	
int	TokenNameint	
targetThroughput	TokenNameIdentifier	 target Throughput
(	TokenNameLPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
DatabaseDescriptor	TokenNameIdentifier	 Database Descriptor
.	TokenNameDOT	
getCompactionThroughputMbPerSec	TokenNameIdentifier	 get Compaction Throughput Mb Per Sec
(	TokenNameLPAREN	
)	TokenNameRPAREN	
<	TokenNameLESS	
1	TokenNameIntegerLiteral	
||	TokenNameOR_OR	
StorageService	TokenNameIdentifier	 Storage Service
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
.	TokenNameDOT	
isBootstrapMode	TokenNameIdentifier	 is Bootstrap Mode
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
// throttling disabled 	TokenNameCOMMENT_LINE	throttling disabled 
return	TokenNamereturn	
0	TokenNameIntegerLiteral	
;	TokenNameSEMICOLON	
// total throughput 	TokenNameCOMMENT_LINE	total throughput 
int	TokenNameint	
totalBytesPerMS	TokenNameIdentifier	 total Bytes Per MS
=	TokenNameEQUAL	
DatabaseDescriptor	TokenNameIdentifier	 Database Descriptor
.	TokenNameDOT	
getCompactionThroughputMbPerSec	TokenNameIdentifier	 get Compaction Throughput Mb Per Sec
(	TokenNameLPAREN	
)	TokenNameRPAREN	
*	TokenNameMULTIPLY	
1024	TokenNameIntegerLiteral	
*	TokenNameMULTIPLY	
1024	TokenNameIntegerLiteral	
/	TokenNameDIVIDE	
1000	TokenNameIntegerLiteral	
;	TokenNameSEMICOLON	
// per stream throughput (target bytes per MS) 	TokenNameCOMMENT_LINE	per stream throughput (target bytes per MS) 
return	TokenNamereturn	
totalBytesPerMS	TokenNameIdentifier	 total Bytes Per MS
/	TokenNameDIVIDE	
Math	TokenNameIdentifier	 Math
.	TokenNameDOT	
max	TokenNameIdentifier	 max
(	TokenNameLPAREN	
1	TokenNameIntegerLiteral	
,	TokenNameCOMMA	
CompactionManager	TokenNameIdentifier	 Compaction Manager
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
.	TokenNameDOT	
getActiveCompactions	TokenNameIdentifier	 get Active Compactions
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
public	TokenNamepublic	
CompactionController	TokenNameIdentifier	 Compaction Controller
(	TokenNameLPAREN	
ColumnFamilyStore	TokenNameIdentifier	 Column Family Store
cfs	TokenNameIdentifier	 cfs
,	TokenNameCOMMA	
Collection	TokenNameIdentifier	 Collection
<	TokenNameLESS	
SSTableReader	TokenNameIdentifier	 SS Table Reader
>	TokenNameGREATER	
sstables	TokenNameIdentifier	 sstables
,	TokenNameCOMMA	
int	TokenNameint	
gcBefore	TokenNameIdentifier	 gc Before
)	TokenNameRPAREN	
{	TokenNameLBRACE	
this	TokenNamethis	
(	TokenNameLPAREN	
cfs	TokenNameIdentifier	 cfs
,	TokenNameCOMMA	
gcBefore	TokenNameIdentifier	 gc Before
,	TokenNameCOMMA	
cfs	TokenNameIdentifier	 cfs
.	TokenNameDOT	
getAndReferenceOverlappingSSTables	TokenNameIdentifier	 get And Reference Overlapping SS Tables
(	TokenNameLPAREN	
sstables	TokenNameIdentifier	 sstables
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
/** * Constructor that subclasses may use when overriding shouldPurge to not need overlappingTree */	TokenNameCOMMENT_JAVADOC	 Constructor that subclasses may use when overriding shouldPurge to not need overlappingTree 
protected	TokenNameprotected	
CompactionController	TokenNameIdentifier	 Compaction Controller
(	TokenNameLPAREN	
ColumnFamilyStore	TokenNameIdentifier	 Column Family Store
cfs	TokenNameIdentifier	 cfs
,	TokenNameCOMMA	
int	TokenNameint	
maxValue	TokenNameIdentifier	 max Value
)	TokenNameRPAREN	
{	TokenNameLBRACE	
this	TokenNamethis	
(	TokenNameLPAREN	
cfs	TokenNameIdentifier	 cfs
,	TokenNameCOMMA	
maxValue	TokenNameIdentifier	 max Value
,	TokenNameCOMMA	
null	TokenNamenull	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
private	TokenNameprivate	
CompactionController	TokenNameIdentifier	 Compaction Controller
(	TokenNameLPAREN	
ColumnFamilyStore	TokenNameIdentifier	 Column Family Store
cfs	TokenNameIdentifier	 cfs
,	TokenNameCOMMA	
int	TokenNameint	
gcBefore	TokenNameIdentifier	 gc Before
,	TokenNameCOMMA	
Set	TokenNameIdentifier	 Set
<	TokenNameLESS	
SSTableReader	TokenNameIdentifier	 SS Table Reader
>	TokenNameGREATER	
overlappingSSTables	TokenNameIdentifier	 overlapping SS Tables
)	TokenNameRPAREN	
{	TokenNameLBRACE	
assert	TokenNameassert	
cfs	TokenNameIdentifier	 cfs
!=	TokenNameNOT_EQUAL	
null	TokenNamenull	
;	TokenNameSEMICOLON	
this	TokenNamethis	
.	TokenNameDOT	
cfs	TokenNameIdentifier	 cfs
=	TokenNameEQUAL	
cfs	TokenNameIdentifier	 cfs
;	TokenNameSEMICOLON	
this	TokenNamethis	
.	TokenNameDOT	
gcBefore	TokenNameIdentifier	 gc Before
=	TokenNameEQUAL	
gcBefore	TokenNameIdentifier	 gc Before
;	TokenNameSEMICOLON	
// If we merge an old CounterId id, we must make sure that no further increment for that id are in an active memtable. 	TokenNameCOMMENT_LINE	If we merge an old CounterId id, we must make sure that no further increment for that id are in an active memtable. 
// For that, we must make sure that this id was renewed before the creation of the oldest unflushed memtable. We 	TokenNameCOMMENT_LINE	For that, we must make sure that this id was renewed before the creation of the oldest unflushed memtable. We 
// add 5 minutes to be sure we're on the safe side in terms of thread safety (though we should be fine in our 	TokenNameCOMMENT_LINE	add 5 minutes to be sure we're on the safe side in terms of thread safety (though we should be fine in our 
// current 'stop all write during memtable switch' situation). 	TokenNameCOMMENT_LINE	current 'stop all write during memtable switch' situation). 
this	TokenNamethis	
.	TokenNameDOT	
mergeShardBefore	TokenNameIdentifier	 merge Shard Before
=	TokenNameEQUAL	
(	TokenNameLPAREN	
int	TokenNameint	
)	TokenNameRPAREN	
(	TokenNameLPAREN	
(	TokenNameLPAREN	
cfs	TokenNameIdentifier	 cfs
.	TokenNameDOT	
oldestUnflushedMemtable	TokenNameIdentifier	 oldest Unflushed Memtable
(	TokenNameLPAREN	
)	TokenNameRPAREN	
+	TokenNamePLUS	
5	TokenNameIntegerLiteral	
*	TokenNameMULTIPLY	
3600	TokenNameIntegerLiteral	
)	TokenNameRPAREN	
/	TokenNameDIVIDE	
1000	TokenNameIntegerLiteral	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
this	TokenNamethis	
.	TokenNameDOT	
overlappingSSTables	TokenNameIdentifier	 overlapping SS Tables
=	TokenNameEQUAL	
overlappingSSTables	TokenNameIdentifier	 overlapping SS Tables
==	TokenNameEQUAL_EQUAL	
null	TokenNamenull	
?	TokenNameQUESTION	
Collections	TokenNameIdentifier	 Collections
.	TokenNameDOT	
<	TokenNameLESS	
SSTableReader	TokenNameIdentifier	 SS Table Reader
>	TokenNameGREATER	
emptySet	TokenNameIdentifier	 empty Set
(	TokenNameLPAREN	
)	TokenNameRPAREN	
:	TokenNameCOLON	
overlappingSSTables	TokenNameIdentifier	 overlapping SS Tables
;	TokenNameSEMICOLON	
overlappingTree	TokenNameIdentifier	 overlapping Tree
=	TokenNameEQUAL	
overlappingSSTables	TokenNameIdentifier	 overlapping SS Tables
==	TokenNameEQUAL_EQUAL	
null	TokenNamenull	
?	TokenNameQUESTION	
null	TokenNamenull	
:	TokenNameCOLON	
DataTracker	TokenNameIdentifier	 Data Tracker
.	TokenNameDOT	
buildIntervalTree	TokenNameIdentifier	 build Interval Tree
(	TokenNameLPAREN	
overlappingSSTables	TokenNameIdentifier	 overlapping SS Tables
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
public	TokenNamepublic	
String	TokenNameIdentifier	 String
getKeyspace	TokenNameIdentifier	 get Keyspace
(	TokenNameLPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
return	TokenNamereturn	
cfs	TokenNameIdentifier	 cfs
.	TokenNameDOT	
table	TokenNameIdentifier	 table
.	TokenNameDOT	
name	TokenNameIdentifier	 name
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
public	TokenNamepublic	
String	TokenNameIdentifier	 String
getColumnFamily	TokenNameIdentifier	 get Column Family
(	TokenNameLPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
return	TokenNamereturn	
cfs	TokenNameIdentifier	 cfs
.	TokenNameDOT	
columnFamily	TokenNameIdentifier	 column Family
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
/** * @return true if it's okay to drop tombstones for the given row, i.e., if we know all the verisons of the row * are included in the compaction set */	TokenNameCOMMENT_JAVADOC	 @return true if it's okay to drop tombstones for the given row, i.e., if we know all the verisons of the row are included in the compaction set 
public	TokenNamepublic	
boolean	TokenNameboolean	
shouldPurge	TokenNameIdentifier	 should Purge
(	TokenNameLPAREN	
DecoratedKey	TokenNameIdentifier	 Decorated Key
key	TokenNameIdentifier	 key
)	TokenNameRPAREN	
{	TokenNameLBRACE	
List	TokenNameIdentifier	 List
<	TokenNameLESS	
SSTableReader	TokenNameIdentifier	 SS Table Reader
>	TokenNameGREATER	
filteredSSTables	TokenNameIdentifier	 filtered SS Tables
=	TokenNameEQUAL	
overlappingTree	TokenNameIdentifier	 overlapping Tree
.	TokenNameDOT	
search	TokenNameIdentifier	 search
(	TokenNameLPAREN	
key	TokenNameIdentifier	 key
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
for	TokenNamefor	
(	TokenNameLPAREN	
SSTableReader	TokenNameIdentifier	 SS Table Reader
sstable	TokenNameIdentifier	 sstable
:	TokenNameCOLON	
filteredSSTables	TokenNameIdentifier	 filtered SS Tables
)	TokenNameRPAREN	
{	TokenNameLBRACE	
if	TokenNameif	
(	TokenNameLPAREN	
sstable	TokenNameIdentifier	 sstable
.	TokenNameDOT	
getBloomFilter	TokenNameIdentifier	 get Bloom Filter
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
isPresent	TokenNameIdentifier	 is Present
(	TokenNameLPAREN	
key	TokenNameIdentifier	 key
.	TokenNameDOT	
key	TokenNameIdentifier	 key
)	TokenNameRPAREN	
)	TokenNameRPAREN	
return	TokenNamereturn	
false	TokenNamefalse	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
return	TokenNamereturn	
true	TokenNametrue	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
public	TokenNamepublic	
void	TokenNamevoid	
invalidateCachedRow	TokenNameIdentifier	 invalidate Cached Row
(	TokenNameLPAREN	
DecoratedKey	TokenNameIdentifier	 Decorated Key
key	TokenNameIdentifier	 key
)	TokenNameRPAREN	
{	TokenNameLBRACE	
cfs	TokenNameIdentifier	 cfs
.	TokenNameDOT	
invalidateCachedRow	TokenNameIdentifier	 invalidate Cached Row
(	TokenNameLPAREN	
key	TokenNameIdentifier	 key
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
public	TokenNamepublic	
void	TokenNamevoid	
removeDeletedInCache	TokenNameIdentifier	 remove Deleted In Cache
(	TokenNameLPAREN	
DecoratedKey	TokenNameIdentifier	 Decorated Key
key	TokenNameIdentifier	 key
)	TokenNameRPAREN	
{	TokenNameLBRACE	
// For the copying cache, we'd need to re-serialize the updated cachedRow, which would be racy 	TokenNameCOMMENT_LINE	For the copying cache, we'd need to re-serialize the updated cachedRow, which would be racy 
// vs other updates. We'll just ignore it instead, since the next update to this row will invalidate it 	TokenNameCOMMENT_LINE	vs other updates. We'll just ignore it instead, since the next update to this row will invalidate it 
// anyway, so the odds of a "tombstones consuming memory indefinitely" problem are minimal. 	TokenNameCOMMENT_LINE	anyway, so the odds of a "tombstones consuming memory indefinitely" problem are minimal. 
// See https://issues.apache.org/jira/browse/CASSANDRA-3921 for more discussion. 	TokenNameCOMMENT_LINE	See https://issues.apache.org/jira/browse/CASSANDRA-3921 for more discussion. 
if	TokenNameif	
(	TokenNameLPAREN	
CacheService	TokenNameIdentifier	 Cache Service
.	TokenNameDOT	
instance	TokenNameIdentifier	 instance
.	TokenNameDOT	
rowCache	TokenNameIdentifier	 row Cache
.	TokenNameDOT	
isPutCopying	TokenNameIdentifier	 is Put Copying
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
return	TokenNamereturn	
;	TokenNameSEMICOLON	
ColumnFamily	TokenNameIdentifier	 Column Family
cachedRow	TokenNameIdentifier	 cached Row
=	TokenNameEQUAL	
cfs	TokenNameIdentifier	 cfs
.	TokenNameDOT	
getRawCachedRow	TokenNameIdentifier	 get Raw Cached Row
(	TokenNameLPAREN	
key	TokenNameIdentifier	 key
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
cachedRow	TokenNameIdentifier	 cached Row
!=	TokenNameNOT_EQUAL	
null	TokenNamenull	
)	TokenNameRPAREN	
ColumnFamilyStore	TokenNameIdentifier	 Column Family Store
.	TokenNameDOT	
removeDeleted	TokenNameIdentifier	 remove Deleted
(	TokenNameLPAREN	
cachedRow	TokenNameIdentifier	 cached Row
,	TokenNameCOMMA	
gcBefore	TokenNameIdentifier	 gc Before
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
/** * @return an AbstractCompactedRow implementation to write the merged rows in question. * * If there is a single source row, the data is from a current-version sstable, we don't * need to purge and we aren't forcing deserialization for scrub, write it unchanged. * Otherwise, we deserialize, purge tombstones, and reserialize in the latest version. */	TokenNameCOMMENT_JAVADOC	 @return an AbstractCompactedRow implementation to write the merged rows in question. * If there is a single source row, the data is from a current-version sstable, we don't need to purge and we aren't forcing deserialization for scrub, write it unchanged. Otherwise, we deserialize, purge tombstones, and reserialize in the latest version. 
public	TokenNamepublic	
AbstractCompactedRow	TokenNameIdentifier	 Abstract Compacted Row
getCompactedRow	TokenNameIdentifier	 get Compacted Row
(	TokenNameLPAREN	
List	TokenNameIdentifier	 List
<	TokenNameLESS	
SSTableIdentityIterator	TokenNameIdentifier	 SS Table Identity Iterator
>	TokenNameGREATER	
rows	TokenNameIdentifier	 rows
)	TokenNameRPAREN	
{	TokenNameLBRACE	
long	TokenNamelong	
rowSize	TokenNameIdentifier	 row Size
=	TokenNameEQUAL	
0	TokenNameIntegerLiteral	
;	TokenNameSEMICOLON	
for	TokenNamefor	
(	TokenNameLPAREN	
SSTableIdentityIterator	TokenNameIdentifier	 SS Table Identity Iterator
row	TokenNameIdentifier	 row
:	TokenNameCOLON	
rows	TokenNameIdentifier	 rows
)	TokenNameRPAREN	
rowSize	TokenNameIdentifier	 row Size
+=	TokenNamePLUS_EQUAL	
row	TokenNameIdentifier	 row
.	TokenNameDOT	
dataSize	TokenNameIdentifier	 data Size
;	TokenNameSEMICOLON	
if	TokenNameif	
(	TokenNameLPAREN	
rowSize	TokenNameIdentifier	 row Size
>	TokenNameGREATER	
DatabaseDescriptor	TokenNameIdentifier	 Database Descriptor
.	TokenNameDOT	
getInMemoryCompactionLimit	TokenNameIdentifier	 get In Memory Compaction Limit
(	TokenNameLPAREN	
)	TokenNameRPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
String	TokenNameIdentifier	 String
keyString	TokenNameIdentifier	 key String
=	TokenNameEQUAL	
cfs	TokenNameIdentifier	 cfs
.	TokenNameDOT	
metadata	TokenNameIdentifier	 metadata
.	TokenNameDOT	
getKeyValidator	TokenNameIdentifier	 get Key Validator
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
getString	TokenNameIdentifier	 get String
(	TokenNameLPAREN	
rows	TokenNameIdentifier	 rows
.	TokenNameDOT	
get	TokenNameIdentifier	 get
(	TokenNameLPAREN	
0	TokenNameIntegerLiteral	
)	TokenNameRPAREN	
.	TokenNameDOT	
getKey	TokenNameIdentifier	 get Key
(	TokenNameLPAREN	
)	TokenNameRPAREN	
.	TokenNameDOT	
key	TokenNameIdentifier	 key
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
logger	TokenNameIdentifier	 logger
.	TokenNameDOT	
info	TokenNameIdentifier	 info
(	TokenNameLPAREN	
String	TokenNameIdentifier	 String
.	TokenNameDOT	
format	TokenNameIdentifier	 format
(	TokenNameLPAREN	
"Compacting large row %s/%s:%s (%d bytes) incrementally"	TokenNameStringLiteral	Compacting large row %s/%s:%s (%d bytes) incrementally
,	TokenNameCOMMA	
cfs	TokenNameIdentifier	 cfs
.	TokenNameDOT	
table	TokenNameIdentifier	 table
.	TokenNameDOT	
name	TokenNameIdentifier	 name
,	TokenNameCOMMA	
cfs	TokenNameIdentifier	 cfs
.	TokenNameDOT	
columnFamily	TokenNameIdentifier	 column Family
,	TokenNameCOMMA	
keyString	TokenNameIdentifier	 key String
,	TokenNameCOMMA	
rowSize	TokenNameIdentifier	 row Size
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
return	TokenNamereturn	
new	TokenNamenew	
LazilyCompactedRow	TokenNameIdentifier	 Lazily Compacted Row
(	TokenNameLPAREN	
this	TokenNamethis	
,	TokenNameCOMMA	
rows	TokenNameIdentifier	 rows
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
return	TokenNamereturn	
new	TokenNamenew	
PrecompactedRow	TokenNameIdentifier	 Precompacted Row
(	TokenNameLPAREN	
this	TokenNamethis	
,	TokenNameCOMMA	
rows	TokenNameIdentifier	 rows
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
/** convenience method for single-sstable compactions */	TokenNameCOMMENT_JAVADOC	 convenience method for single-sstable compactions 
public	TokenNamepublic	
AbstractCompactedRow	TokenNameIdentifier	 Abstract Compacted Row
getCompactedRow	TokenNameIdentifier	 get Compacted Row
(	TokenNameLPAREN	
SSTableIdentityIterator	TokenNameIdentifier	 SS Table Identity Iterator
row	TokenNameIdentifier	 row
)	TokenNameRPAREN	
{	TokenNameLBRACE	
return	TokenNamereturn	
getCompactedRow	TokenNameIdentifier	 get Compacted Row
(	TokenNameLPAREN	
Collections	TokenNameIdentifier	 Collections
.	TokenNameDOT	
singletonList	TokenNameIdentifier	 singleton List
(	TokenNameLPAREN	
row	TokenNameIdentifier	 row
)	TokenNameRPAREN	
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
public	TokenNamepublic	
void	TokenNamevoid	
mayThrottle	TokenNameIdentifier	 may Throttle
(	TokenNameLPAREN	
long	TokenNamelong	
currentBytes	TokenNameIdentifier	 current Bytes
)	TokenNameRPAREN	
{	TokenNameLBRACE	
throttle	TokenNameIdentifier	 throttle
.	TokenNameDOT	
throttle	TokenNameIdentifier	 throttle
(	TokenNameLPAREN	
currentBytes	TokenNameIdentifier	 current Bytes
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
public	TokenNamepublic	
void	TokenNamevoid	
close	TokenNameIdentifier	 close
(	TokenNameLPAREN	
)	TokenNameRPAREN	
{	TokenNameLBRACE	
SSTableReader	TokenNameIdentifier	 SS Table Reader
.	TokenNameDOT	
releaseReferences	TokenNameIdentifier	 release References
(	TokenNameLPAREN	
overlappingSSTables	TokenNameIdentifier	 overlapping SS Tables
)	TokenNameRPAREN	
;	TokenNameSEMICOLON	
}	TokenNameRBRACE	
}	TokenNameRBRACE	
